---
title: "<img src='www/deriv.jpg' width='240'>"
subtitle: "[Deriv.com](https://github.com/englianhu/binary.com-interview-question) - Interday High Frequency Trading Models Comparison <span style='color:#4E79A7'>**Review (Part I)**</span>"
author: "[®γσ, Lian Hu](https://englianhu.github.io/) <img src='www/quantitative trader 1.jpg' width='24'> <img src='www/RYU.jpg' width='24'> <img src='www/ENG.jpg' width='24'>® <img src='www/xueba1.jpg' width='24'>"
date: "`r lubridate::today('Asia/Tokyo')`"
output:
  html_document: 
    mathjax: https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js
    number_sections: yes
    toc: yes
    toc_depth: 4
    toc_float:
      collapsed: yes
      smooth_scroll: yes
    code_folding: hide
    css: CSSBackgrounds.css
---

# Abstract

Due to below isseus from [<span style='color:goldenrod'>*Deriv.com - Interday High Frequency Trading Models Comparison</span> <span style='color:red'>**Blooper**</span>](https://rpubs.com/englianhu/binary-Q1Inter-HFT), here I review the researh by using same dataset.

- Weekly dataset `7200` mins forecast in advanced despite `Saturday` and `Sunday`.
- Use the dataset `data_m1` from `2015-01-05` to `2017-12-31`.
- Use `Close Price` to ease the workload and some errors (ex: OHLC abnor, NA price).

<span style='color:red'>**Load Packages**</span>

```{r, warning = FALSE, message = FALSE}
if(!suppressPackageStartupMessages(require('BBmisc'))) {
  install.packages('BBmisc', dependencies = TRUE, INSTALL_opts = '--no-lock')
}
suppressPackageStartupMessages(require('BBmisc'))
# suppressPackageStartupMessages(require('rmsfuns'))

pkgs <- c('devtools', 'knitr', 'kableExtra', 'tint', 'dygraphs', 
          'devtools','readr', 'lubridate', 'data.table', 'reprex', 
          'feather', 'purrr', 'quantmod', 'tidyquant', 'plotly', 
          'tibbletime', 'furrr', 'flyingfox', 'tidyr', 'jsonlite', 
          'timetk', 'plyr', 'dplyr', 'stringr', 'magrittr', 'tdplyr', 
          'tidyverse', 'memoise', 'htmltools', 'formattable', 'rbokeh', 
          'dash', 'dashCoreComponents', 'dashHtmlComponents', 'dtplyr', 
          ##https://dashr.plotly.com
          'zoo', 'forecast', 'seasonal', 'seasonalview', 'rjson', 
          'rugarch', 'rmgarch', 'mfGARCH', 'sparklyr', 'jcolors', 
          'microbenchmark', 'dendextend', 'lhmetools', 'ggthemr', 
          'stringr', 'pacman', 'profmem', 'DescTools', 'ggthemes', 
          'htmltools', 'echarts4r', 'viridis', 'hrbrthemes', 
          'fable', 'fabletools', 'Rfast', 'Metrics', 'MLmetrics')

## https://www.jianshu.com/p/4beb3d34ced2
#unlink('C:/Program Files/R/R-4.0.3/library/withr', recursive = TRUE)
#install.packages('withr', dependencies = TRUE, INSTALL_opts = '--no-lock')

# https://github.com/mpiktas/midasr
# https://github.com/onnokleen/mfGARCH
# devtools::install_github("business-science/tibbletime")
# devtools::install_github("DavisVaughan/furrr")

suppressAll(lib(pkgs))
# load_pkg(pkgs)

dtr <- 'C:/Users/User/Documents/GitHub/binary.com-interview-question-data/'

## Set the timezone but not change the datetime
Sys.setenv(TZ = 'Asia/Tokyo')
## options(knitr.table.format = 'html') will set all kableExtra tables to be 'html', otherwise need to set the parameter on every single table.
options(warn = -1, knitr.table.format = 'html')#, digits.secs = 6)

## https://stackoverflow.com/questions/39417003/long-vectors-not-supported-yet-abnor-in-rmd-but-not-in-r-script
knitr::opts_chunk$set(cache = TRUE, warning = FALSE, 
                      message = FALSE, cache.lazy = FALSE)

rm(pkgs)
```

<span style='color:red'>**Progress Function**</span>

```{r}
task_progress <- function(mbase, timeID0 = NULL, scs = 60, .pattern = '^mts|^sets', .loops = TRUE) {
  ## ------------- 定时查询进度 ----------------------
  ## 每分钟自动查询与更新以上模拟预测汇价进度（储存文件量）。
  require('magrittr')
  require('tibble')
  
  if(!is.data.frame(class(mbase))) { 
	mbase %<>% data.frame
  }
  
  if (.loops == TRUE) {
    while(1) {
      cat('Current Tokyo Time :', as.character(now('Asia/Tokyo')), '\n\n')
      
      y = as_date(mbase$index) %>% 
			unique
      y <- y[weekdays(y) != 'Saturday'] #filter and omit the weekly last price which is 12:00am on saturday
	    datee = y
	    
	    if(is.null(timeID0)) { 
		    timeID0 = y[1]
	    } else if (is.Date(timeID0)) { 
		    timeID0 = as_date(timeID0)
	    } else {
		    timeID0 = as_date(mbase$index) %>% 
		    unique
	    }
  	  
	    y = y[y >= timeID0]
      
      x = list.files(paste0(dtr, 'data/fx/USDJPY/'), pattern = .pattern) %>% 
	      str_replace_all('.rds', '') %>% 
		  str_replace_all('.201', '_201') %>% 
		  str_split_fixed('_', '2') %>% 
		  as_tibble %>% 
		  dplyr::rename('Model' = 'V1', 'Date' = 'V2') %>% 
		  dplyr::mutate(Model = factor(Model), Date = as_date(Date))
		
	  x = join(tibble(Date = datee), x) %>% 
		  as_tibble	  
	  x %<>% na.omit
	  
      x %<>% dplyr::mutate(binary = if_else(is.na(Model), 0, 1)) %>% 
		  spread(Model, binary)
      
      z <- ldply(x[,-1], function(zz) {
		  na.omit(zz) %>% length }) %>% 
		  dplyr::rename(x = V1) %>% 
		  dplyr::mutate(n = length(y), progress = percent(x/n))
      
      print(z)
      
      prg = sum(z$x)/sum(z$n)
      cat('\n================', as.character(percent(prg)), '================\n\n')
      
      if (prg == 1) break #倘若进度达到100%就停止更新。
      
      Sys.sleep(scs) #以上ldply()耗时3~5秒，而休息时间60秒。
    }
  } else {
    
    cat('Current Tokyo Time :', as.character(now('Asia/Tokyo')), '\n\n')
      
    
      y = as_date(mbase$index) %>% 
			unique
	  datee = y
		
	  if(is.null(timeID0)) { 
		  timeID0 = y[1]
	  } else if (is.Date(timeID0)) { 
		  timeID0 = as_date(timeID0)
	  } else {
		  timeID0 = as_date(mbase$index) %>% 
		  unique
	  }
	
	  y = y[y >= timeID0]
    
      x = list.files(paste0(dtr, 'data/fx/USDJPY/'), pattern = .pattern) %>% 
	      str_replace_all('.rds', '') %>% 
		  str_replace_all('.201', '_201') %>% 
		  str_split_fixed('_', '2') %>% 
		  as_tibble %>% 
		  dplyr::rename('Model' = 'V1', 'Date' = 'V2') %>% 
		  dplyr::mutate(Model = factor(Model), Date = as_date(Date))
		
	  x = join(tibble(Date = datee), x) %>% 
		  as_tibble
	  x %<>% na.omit
	  
      x %<>% dplyr::mutate(binary = if_else(is.na(Model), 0, 1)) %>% 
		  spread(Model, binary)
        
      z <- ldply(x[,-1], function(zz) {
		  na.omit(zz) %>% length }) %>% 
		  dplyr::rename(x = V1) %>% 
		  dplyr::mutate(n = length(y), progress = percent(x/n))
                
    print(z)
    
    prg = sum(z$x)/sum(z$n)
    cat('\n================', as.character(percent(prg)), '================\n\n')
    }
  }
```

# Introduction

Review the [<span style='color:goldenrod'>*Deriv.com - Interday High Frequency Trading Models Comparison</span> <span style='color:red'>**Blooper**</span>](https://rpubs.com/englianhu/binary-Q1Inter-HFT).

# Data

## Read Data

### Raw Data

```{r, warning = FALSE, message = FALSE, results = 'asis'}
data_m1 <- read_rds('C:/Users/User/Documents/GitHub/real-time-fxcm/data/USDJPY/data_m1.rds') %>% 
  data.table
data_m1 %<>% .[order(index)]

## plot sample data
data_m1[c(1:3, (nrow(data_m1)-3):nrow(data_m1)),] %>% 
  kbl('html', caption = '1 min Raw Dataset', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(4, background = 'LightGray', color = 'goldenrod') %>% 
  column_spec(5, background = 'Gainsboro', color = 'goldenrod') %>% 
  column_spec(6, background = 'LightGray', color = 'goldenrod') %>% 
  column_spec(7, background = 'Gainsboro', color = 'goldenrod') %>% 
  column_spec(8, background = 'LightGray', color = 'goldenrod') %>% 
  column_spec(9, background = 'Gainsboro', color = 'goldenrod') %>% 
  column_spec(10, background = 'LightGray', color = 'goldenrod') %>% 
  column_spec(11, background = 'Gainsboro', color = 'goldenrod') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE, height = '400px')
```

*source : `r paste0(dim(data_m1), collapse = ' x ')`*

As we can know there has few errors from [<span style='color:goldenrod'>*Deriv.com - Interday High Frequency Trading Models Comparison</span> <span style='color:red'>**Blooper**</span>](https://rpubs.com/englianhu/binary-Q1Inter-HFT):

- open price higher than highest price
- open price lower than lowest price
- close price higher than highest price
- close price lower than lowest price

### OHLC Data

Convert to OHLC data as we know from [<span style='color:goldenrod'>*Deriv.com - Interday High Frequency Trading Models Comparison</span> <span style='color:red'>**Blooper**</span>](https://rpubs.com/englianhu/binary-Q1Inter-HFT).

```{r, warning = FALSE, message = FALSE, results = 'asis'}
if(names(data_m1) %>% str_detect('Bid|Ask') %>% any()) {
  dsmp <- data_m1[,{
    open = (BidOpen + AskOpen)/2 
    high = (BidHigh + AskHigh)/2 
    low = (BidLow + AskLow)/2 
    close = (BidClose + AskClose)/2
    .SD[,.(index = index, year = year, week = week, 
           open = open, high = high, low = low, close = close), ]}, ]
}

## plot sample data
dsmp[c(1:3, (nrow(dsmp)-3):nrow(dsmp)),] %>% 
  kbl('html', caption = '1 min OHLC Dataset', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(4, background = 'LightGray', color = 'goldenrod') %>% 
  column_spec(5, background = 'Gainsboro', color = 'goldenrod') %>% 
  column_spec(6, background = 'LightGray', color = 'goldenrod') %>% 
  column_spec(7, background = 'Gainsboro', color = 'goldenrod') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE, height = '400px')
```

*source : `r paste0(dim(dsmp), collapse = ' x ')`*

## Data Cleaning

```{r, warning = FALSE, message = FALSE, results = 'asis'}
dsmp <- dsmp[,{
  quarter = quarter(index)
  month = month(index)
  wkdays = weekdays(index)
  wk_1m = 1:7200
  dy_1m = 1:1440
  hr_1m = 1:60
  date = as_date(index)
  .SD[,.(index = index, year = year, quarter = quarter, 
         month = month, week = week, wkdays = wkdays, 
         wk_1m = wk_1m, dy_1m = dy_1m, hr_1m = hr_1m, 
         sq = 1:.N, date = date, close = close), ]}, ]
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
## plot sample data
dsmp[c(1:3, (nrow(dsmp)-3):nrow(dsmp)),] %>% 
  kbl('html', caption = '1 min Close Price Dataset', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  ## https://public.tableau.com/en-us/gallery/100-color-palettes?gallery=votd
  row_spec(0, background = 'DimGrey', color = 'gold', bold = TRUE) %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'Gray') %>% 
  column_spec(3, background = 'DarkGrey') %>% 
  column_spec(4, background = 'Gray') %>% 
  column_spec(5, background = 'DarkGrey') %>% 
  column_spec(6, background = '#4897D8') %>% 
  column_spec(7, background = '#556DAC') %>% 
  column_spec(8, background = '#92AAC7') %>% 
  column_spec(9, background = '#556DAC') %>% 
  column_spec(10, background = '#375E97') %>% 
  column_spec(11, background = 'CornflowerBlue') %>% 
  column_spec(12, background = 'LightGray', color = 'goldenrod') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE, height = '400px')
```

*source : `r paste0(dim(dsmp), collapse = ' x ')`*

```{r, warning = FALSE, message = FALSE, results = 'asis'}
## Below codes list out all Tuesday to Sunday data details.
# data_abn <- dsmp[wkdays %chin% 'Saturday' & !str_detect(index, '00:00:00') | wkdays %chin% 'Sunday']$date
# date_abn2 <- date_abn[1:length(date_abn) %% 2 == 0]
## --------------------------------------------
date_abn <- dsmp[wkdays %chin% 'Sunday']$date %>% 
  unique
date_abn_seq <- llply(date_abn, function(dte) 
  as.character(seq(dte - days(6), dte, by = 'day'))) %>% 
  unlist %>% 
  as_date

rm(date_abn, date_abn2)
data_abn <- dsmp[date %in% date_abn_seq]

## plot sample data
data_abn[c(1:3, (nrow(data_abn)-3):nrow(data_abn)),] %>% 
  kbl('html', caption = '1 min Close Price Dataset (abnor : Tuesday - Sunday)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  ## https://public.tableau.com/en-us/gallery/100-color-palettes?gallery=votd
  row_spec(0, background = 'DimGrey', color = 'gold', bold = TRUE) %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'Gray') %>% 
  column_spec(3, background = 'DarkGrey') %>% 
  column_spec(4, background = 'Gray') %>% 
  column_spec(5, background = 'DarkGrey') %>% 
  column_spec(6, background = '#4897D8') %>% 
  column_spec(7, background = '#556DAC') %>% 
  column_spec(8, background = '#92AAC7') %>% 
  column_spec(9, background = '#556DAC') %>% 
  column_spec(10, background = '#375E97') %>% 
  column_spec(11, background = 'CornflowerBlue') %>% 
  column_spec(12, background = 'LightGray', color = 'goldenrod') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE, height = '400px')
```

There has transactions in from *Tuesday (12:01AM)* to *Sunday (12:00AM)* as we can know from above and below.

```{r, eval = FALSE, warning = FALSE, message = FALSE}
## -------------------- eval = FALSE --------------------
matrix(weekdays(unique(as_date(dsmp$index))), ncol = 6, byrow = TRUE)
[104,] "Tuesday" "Wednesday" "Thursday"  "Friday"   "Saturday" "Sunday"  
[105,] "Tuesday" "Wednesday" "Thursday"  "Friday"   "Saturday" "Sunday"
...
[156,] "Tuesday" "Wednesday" "Thursday"  "Friday"   "Saturday" "Sunday" 
[157,] "Tuesday" "Wednesday" "Thursday"  "Friday"   "Saturday" "Sunday"
```

There has 2 weeks abnormal data (`r paste(date_abn_seq[c(1,(length(date_abn_seq)/2))], collapse = ' to ')` and `r paste(date_abn_seq[c(((length(date_abn_seq)/2)+1),length(date_abn_seq))], collapse = ' to ')`).

There might probably because of Christmas to postpone 1 day, here I forecast `7200` trading datetime in advanced despite the date and weekdays. Every forecast price will base on the out of sample date. There will no any effects .

```{r, warning = FALSE, message = FALSE}
## check if data path set
if(!exists('dtr')) {
  dtr <- 'C:/Users/User/Documents/GitHub/binary.com-interview-question-data/'}

## save files if not exists
if(!file.exists(paste0(dtr, 'data/fx/USDJPY/dsmp.rds')) & exists('dsmp')) {
  saveRDS(dsmp, paste0(dtr, 'data/fx/USDJPY/dsmp.rds'))}

## read files if not exists
if(!exists('dsmp')) {
  dsmp <- readRDS(paste0(dtr, 'data/fx/USDJPY/dsmp.rds'))}
```

# Modelling

Due to I have annually length dataset, here I start my 1st forecast date from 1st trading datetime of 2016 (`r dsmp)[year == 2016]$date[1]` which is 2nd year in dataset).

## Seasonal `ts()`

### Daily Seasonal Data

#### Seasonal Data Modeling

I set the length of data as weekly (`7200` minutes which is 5 trading days) to forecast `1440` minutes (`1440` minutes is a trading day).

[*Chapter 7 Multivariate TS Analysis* in **Introduction to Time Series Analysis and Forecasting in R**](https://bookdown.org/singh_pratap_tejendra/intro_time_series_r/multivariate-ts-analysis.html), but I use univariate due to some errors as mentioned in beginning.

I tried to use `weeks(1)`, `months(3)`, `years(1)` but there is not constant observations, we can refer to [`The seasonal period`](https://otexts.com/fpp3/tsibble-objects.html).

Here I filter up the data as below :

- `5 days * 1440 mins = 7200 mins` = weekly
- `22 days * 1440 mins = 31680 mins` = monthly
- `3 months * 22 days * 1440 mins = 95040 mins` = quarterly
- `52 weeks * 5 days * 1440 mins = 374400 mins` = yearly

```{r, warning = FALSE, message = FALSE, results = 'asis'}
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 7200 #last 7200  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 1440

for (i in c(1, 6:8, length(timeID) - 1, length(timeID))) { #Here I print 8 elements as examples
  
  if(i == 1) {
    
    cat('\n')
    cat('===========================================\n')
    cat('train[', i, ']\n')
    print(train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N])
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('train_test[', i, ']\n')
    
    print(train_test <- dsmp[sq %in% ctr])
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
	    dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
	                  mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('forecast[', i, ']\n')
    
    print(sets %>% as.data.table)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))

    cat('\n')
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
    cat('\n\n')
    
  } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
    
    
  } else if(i == length(timeID)) {
    
    
  } else  {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    
    cat('\n')
    cat('===========================================\n')
    cat('train[', i, ']\n')
    
    print(train <- dsmp[(lst_sq - data_len + 1):lst_sq])
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('train_test[', i, ']\n')
    
    print(train_test <- dsmp[sq %in% ctr])
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
      dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                    mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('forecast[', i, ']\n')
    
    print(sets %>% as.data.table)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))

    cat('\n')
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
    cat('\n\n')
    
  }
}
```

#### Wk >> Dy

I set the length of data as weekly (`5 days * 1440 mins = 7200 mins` minutes which is 5 trading days) to forecast `1440` minutes (`1440` minutes is a trading day).

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 7200 #last 7200  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 1440

for (i in 1:length(timeID)) {

  if(i == 1) {
    
    cat('\n')
    cat('===========================================\n')
    cat('train[', i, ']\n')
    print(train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N])
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('train_test[', i, ']\n')
    
    print(train_test <- dsmp[sq %in% ctr])
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
	    dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
	                  mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('forecast[', i, ']\n')
    
    print(sets %>% as.data.table)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))

    cat('\n')
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
    cat('\n\n')
    
  } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
    
    
  } else if(i == length(timeID)) {
    
    
  } else  {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    
    cat('\n')
    cat('===========================================\n')
    cat('train[', i, ']\n')
    
    print(train <- dsmp[(lst_sq - data_len + 1):lst_sq])
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('train_test[', i, ']\n')
    
    print(train_test <- dsmp[sq %in% ctr])
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
      dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                    mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('forecast[', i, ']\n')
    
    print(sets %>% as.data.table)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat('\n')
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
    cat('\n\n')
  }
}
```

#### Mn >> Dy

I set the length of data as monthly (`22 days * 1440 mins = 31680 mins` minutes which is 22 trading days) to forecast `1440` minutes (`1440` minutes is a trading day).

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 22 * 1440 #last 31680  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 1440

for (i in 1:length(timeID)) {
  
  if(i == 1) {
    
    cat('\n')
    cat('===========================================\n')
    train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
	    dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
	                  mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))

    cat(i, '=', paste0('~/data/fx/USDJPY/ts', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))

  } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
    
    
  } else if(i == length(timeID)) {
    
    
  } else  {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    train <- dsmp[(lst_sq - data_len + 1):lst_sq]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
      dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                    mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
  }
}
```

#### Qt >> Dy

I set the length of data as quarterly (`3 months * 22 days * 1440 mins = 95040 mins` minutes which is 66 trading days) to forecast `1440` minutes (`1440` minutes is a trading day).

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 3 * 22 * 1440 #last 95040  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 1440

for (i in 1:length(timeID)) {
  
  if(i == 1) {
    
    cat('\n')
    cat('===========================================\n')
    train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
	    dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
	                  mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))

    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))

  } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
    
    
  } else if(i == length(timeID)) {
    
    
  } else  {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    train <- dsmp[(lst_sq - data_len + 1):lst_sq]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
      dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                    mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
  }
}
```

#### Yr >> Dy

I set the length of data as yearly (`52 weeks * 5 days * 1440 mins = 374400 mins` minutes which is 260 trading days) to forecast `1440` minutes (`1440` minutes is a trading day).

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 52 * 5 * 1440 #last 374400  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 1440

for (i in 1:length(timeID)) {
  
  if(i == 1) {
    
    cat('\n')
    cat('===========================================\n')
    train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
	    dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
	                  mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
  
  } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
    
    
  } else if(i == length(timeID)) {
    
    
  } else  {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    train <- dsmp[(lst_sq - data_len + 1):lst_sq]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
      dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                    mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
  }
}
```

### Weekly Seasonal Data

#### Wk >> Wk

I set the length of data as weekly (`5 days * 1440 mins = 7200 mins` minutes which is 22 trading days) to forecast `7200` minutes (`7200` minutes is 5 trading day).

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 7200 #last 7200  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 7200
hrz2 <- 1440

for (i in 1:length(timeID)) {
  
  if(i == 1) {
    
    cat('\n')
    cat('===========================================\n')
    cat('train[', i, ']\n')
    print(train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N])
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('train_test[', i, ']\n')
    
    print(train_test <- dsmp[sq %in% ctr])
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
	    dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
	                  mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('forecast[', i, ']\n')
    
    print(sets %>% as.data.table)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))

    cat('\n')
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
    cat('\n\n')
    
  } else if(i > (length(timeID) - hrz1/hrz2) & i != length(timeID)) {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    ## filter the length of forecasted data to fit with train_test data 
    ##   when the length of forecasted data more then length of test data.
    #lst_date <- timeID[(length(timeID) - (hrz1/hrz2)):length(timeID)]
    lst_date <- timeID[timeID >= timeID[i]]
    lst_date_sq <- grep(
      timeID[i], timeID[(length(timeID) - (hrz1/hrz2 - 1)):length(timeID)])
    
    cat('\n')
    cat('===========================================\n')
    cat('train[', i, ']\n')
    
    print(train <- dsmp[(lst_sq - data_len + 1):lst_sq])
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('train_test[', i, ']\n')
    
    print(train_test <- dsmp[sq %in% ctr])
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl
    
    sets <- sets[1:(hrz1 - (hrz2 * lst_date_sq)),] %>% 
      dplyr::mutate(index = train_test[
        (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$index, 
        mk.price = train_test[
          (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('forecast[', i, ']\n')
    
    print(sets %>% as.data.table)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat('\n')
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
    cat('\n\n')    
	
  } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
    
    
  } else if(i == length(timeID)) {
    
    
  } else {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    
    cat('\n')
    cat('===========================================\n')
    cat('train[', i, ']\n')
    
    print(train <- dsmp[(lst_sq - data_len + 1):lst_sq])
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('train_test[', i, ']\n')
    
    print(train_test <- dsmp[sq %in% ctr])
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
      dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                    mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    cat('\n')
    cat('-------------------------------------------\n')
    cat('forecast[', i, ']\n')
    
    print(sets %>% as.data.table)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat('\n')
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
    cat('\n\n')
  }
}
```

#### Mn >> Wk

I set the length of data as monthly (`22 days * 1440 mins = 31680 mins` minutes which is 22 trading days) to forecast `7200` minutes (`7200` minutes is 5 trading day).

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 22 * 1440 #last 31680  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 7200
hrz2 <- 1440

for (i in 1:length(timeID)) {
  
  if(i == 1) {
    
    cat('\n')
    cat('===========================================\n')
    train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
	    dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
	                  mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
    
  } else if(i > (length(timeID) - hrz1/hrz2) & i != length(timeID)) {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    ## filter the length of forecasted data to fit with train_test data 
    ##   when the length of forecasted data more then length of test data.
    #lst_date <- timeID[(length(timeID) - (hrz1/hrz2)):length(timeID)]
    lst_date <- timeID[timeID >= timeID[i]]
    lst_date_sq <- grep(
      timeID[i], timeID[(length(timeID) - (hrz1/hrz2 - 1)):length(timeID)])
    
    cat('\n')
    cat('===========================================\n')
    train <- dsmp[(lst_sq - data_len + 1):lst_sq]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl
    
    sets <- sets[1:(hrz1 - (hrz2 * lst_date_sq)),] %>% 
      dplyr::mutate(index = train_test[
        (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$index, 
        mk.price = train_test[
          (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
  } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
    
    
  } else if(i == length(timeID)) {
    
    
  } else {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    train <- dsmp[(lst_sq - data_len + 1):lst_sq]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
      dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                    mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
  }
}
```

#### Qt >> Wk

I set the length of data as quarterly (`3 months * 22 days * 1440 mins = 95040 mins` minutes which is 66 trading days) to forecast `7200` minutes (`7200` minutes is 5 trading day).

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 3 * 22 * 1440 #last 95040  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 7200
hrz2 <- 1440

for (i in 1:length(timeID)) {
  
  if(i == 1) {
    
    cat('\n')
    cat('===========================================\n')
    train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
	    dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
	                  mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
    
  } else if(i > (length(timeID) - hrz1/hrz2) & i != length(timeID)) {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    ## filter the length of forecasted data to fit with train_test data 
    ##   when the length of forecasted data more then length of test data.
    #lst_date <- timeID[(length(timeID) - (hrz1/hrz2)):length(timeID)]
    lst_date <- timeID[timeID >= timeID[i]]
    lst_date_sq <- grep(
      timeID[i], timeID[(length(timeID) - (hrz1/hrz2 - 1)):length(timeID)])
    
    cat('\n')
    cat('===========================================\n')
    train <- dsmp[(lst_sq - data_len + 1):lst_sq]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl
    
    sets <- sets[1:(hrz1 - (hrz2 * lst_date_sq)),] %>% 
      dplyr::mutate(index = train_test[
        (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$index, 
        mk.price = train_test[
          (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
  } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
    
    
  } else if(i == length(timeID)) {
    
    
  } else {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    train <- dsmp[(lst_sq - data_len + 1):lst_sq]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
      dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                    mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
  }
}
```

#### Yr >> Wk

I set the length of data as yearly (`52 weeks * 5 days * 1440 mins = 374400 mins` minutes which is 260 trading days) to forecast `7200` minutes (`7200` minutes is 5 trading day).

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 52 * 5 * 1440 #last 374400  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 7200
hrz2 <- 1440

for (i in 1:length(timeID)) {
  
  if(i == 1) {
    
    cat('\n')
    cat('===========================================\n')
    train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
	    dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
	                  mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
    
  } else if(i > (length(timeID) - hrz1/hrz2) & i != length(timeID)) {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    ## filter the length of forecasted data to fit with train_test data 
    ##   when the length of forecasted data more then length of test data.
    #lst_date <- timeID[(length(timeID) - (hrz1/hrz2)):length(timeID)]
    lst_date <- timeID[timeID >= timeID[i]]
    lst_date_sq <- grep(
      timeID[i], timeID[(length(timeID) - (hrz1/hrz2 - 1)):length(timeID)])
    
    cat('\n')
    cat('===========================================\n')
    train <- dsmp[(lst_sq - data_len + 1):lst_sq]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl
    
    sets <- sets[1:(hrz1 - (hrz2 * lst_date_sq)),] %>% 
      dplyr::mutate(index = train_test[
        (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$index, 
        mk.price = train_test[
          (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
  } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
    
    
  } else if(i == length(timeID)) {
    
    
  } else {
    
    lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
    train <- dsmp[(lst_sq - data_len + 1):lst_sq]
    ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
    train_test <- dsmp[sq %in% ctr]
    
    sets <- train[, .(index, close)] %>% 
      tk_ts(frequency = hrz1) %>% 
      forecast(h = hrz1) %>% 
      tk_tbl %>% 
      dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                    mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
      dplyr::rename(fc.price = `Point Forecast`) %>% 
      dplyr::select(index, mk.price, fc.price)
    
    saveRDS(sets, paste0(
      dtr, 'data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
      as_date(sets$index[1]), '.rds'))
    
    cat(i, '=', paste0('~/data/fx/USDJPY/ts_', data_len, '_', hrz1, '.', 
                       as_date(sets$index[1]), '.rds saved!\n'))
  }
}
```

## Exponential `ts()` & `ets()`

### Daily Seasonal Data

#### Modelling

```{r eval = FALSE}
## set all models provided by ets function.
ets.m <- c('AAN', 'AAZ', 'ANN', 'ANZ', 'AZN', 'AZZ', 'MAN', 'MAZ', 'MMN', 
            'MMZ', 'MNN', 'MNZ', 'MZN', 'MZZ', 'ZAN', 'ZAZ', 'ZMN', 'ZMZ', 
            'ZNN', 'ZNZ', 'ZZN', 'ZZZ')


tseas <- function(timeID, data = dsmp, data_len, 
                  hrz1 = c(1440, 7200), hrz2 = 1440, .model) {
	
	if(hrz1 == 1440) {
	  
	  tmp <- llply(1:length(timeID), function(i) {
	    if(i == 1) {
	      
	      cat('\n')
        cat('===========================================\n')
        cat('train[', i, ']\n')
        print(train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N])
        ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('train_test[', i, ']\n')
        
        print(train_test <- dsmp[sq %in% ctr])
        
        sets <- train[, .(index, close)] %>% 
          tk_ts(frequency = hrz1) %>% 
          ets(model = .model) %>% 
          forecast(h = hrz1) %>% 
          tk_tbl %>% 
          dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                        mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
          dplyr::rename(fc.price = `Point Forecast`) %>% 
          dplyr::select(index, mk.price, fc.price)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('forecast[', i, ']\n')
        
        print(sets %>% as.data.table)
        
        saveRDS(sets, paste0(
          dtr, 'data/fx/USDJPY/ets_', .model, '_', data_len, 
          '_', hrz1, '.', as_date(sets$index[1]), '.rds'))
        
        cat('\n')
        cat(i, '=', paste0('~/data/fx/USDJPY/ets_', .model, '_', 
                           data_len, '_', hrz1, '.', 
                           as_date(sets$index[1]), '.rds saved!\n'))
        cat('\n\n')
        rm(sets)
        
      } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
        
        
      } else if(i == length(timeID)) {
        
        
      } else  {
        
        lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
        
        cat('\n')
        cat('===========================================\n')
        cat('train[', i, ']\n')
        
        print(train <- dsmp[(lst_sq - data_len + 1):lst_sq])
        ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('train_test[', i, ']\n')
        
        print(train_test <- dsmp[sq %in% ctr])
        
        sets <- train[, .(index, close)] %>% 
          tk_ts(frequency = hrz1) %>% 
          ets(model = .model) %>% 
          forecast(h = hrz1) %>% 
          tk_tbl %>% 
          dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                        mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
          dplyr::rename(fc.price = `Point Forecast`) %>% 
          dplyr::select(index, mk.price, fc.price)
          
        cat('\n')
        cat('-------------------------------------------\n')
        cat('forecast[', i, ']\n')
        
        print(sets %>% as.data.table)
        
        saveRDS(sets, paste0(
          dtr, 'data/fx/USDJPY/ets_', .model, '_', data_len, 
          '_', hrz1, '.', as_date(sets$index[1]), '.rds'))
        
        cat('\n')
        cat(i, '=', paste0('~/data/fx/USDJPY/ets_', .model, '_', 
                           data_len, '_', hrz1, '.', 
                           as_date(sets$index[1]), '.rds saved!\n'))
        cat('\n\n')
        rm(sets)
      }
    })
	} else if(hrz1 == 7200) {
	  
	  tmp <- llply(1:length(timeID), function(i) {
	    
	    if(i == 1) {
	      
	      cat('\n')
        cat('===========================================\n')
        cat('train[', i, ']\n')
        print(train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N])
        ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('train_test[', i, ']\n')
        
        print(train_test <- dsmp[sq %in% ctr])
        
        sets <- train[, .(index, close)] %>% 
          tk_ts(frequency = hrz1) %>% 
          ets(model = .model) %>% 
          forecast(h = hrz1) %>% 
          tk_tbl %>% 
          dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                        mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
          dplyr::rename(fc.price = `Point Forecast`) %>% 
          dplyr::select(index, mk.price, fc.price)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('forecast[', i, ']\n')
        
        print(sets %>% as.data.table)
        
        saveRDS(sets, paste0(
          dtr, 'data/fx/USDJPY/ets_', .model, '_', data_len, 
          '_', hrz1, '.', as_date(sets$index[1]), '.rds'))
        
        cat('\n')
        cat(i, '=', paste0('~/data/fx/USDJPY/ets_', .model, '_', 
                           data_len, '_', hrz1, '.', 
                           as_date(sets$index[1]), '.rds saved!\n'))
        cat('\n\n')
        rm(sets)
        
      } else if(i > (length(timeID) - hrz1/hrz2) & i != length(timeID)) {
        
        lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
        ## filter the length of forecasted data to fit with train_test data 
        ##   when the length of forecasted data more then length of test data.
        #lst_date <- timeID[(length(timeID) - (hrz1/hrz2)):length(timeID)]
        lst_date <- timeID[timeID >= timeID[i]]
        lst_date_sq <- grep(
          timeID[i], timeID[
            (length(timeID) - (hrz1/hrz2 - 1)):length(timeID)])
        
        cat('\n')
        cat('===========================================\n')
        cat('train[', i, ']\n')
        
        print(train <- dsmp[(lst_sq - data_len + 1):lst_sq])
        ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('train_test[', i, ']\n')
        
        print(train_test <- dsmp[sq %in% ctr])
        
        sets <- train[, .(index, close)] %>% 
          tk_ts(frequency = hrz1) %>% 
          ets(model = .model) %>% 
          forecast(h = hrz1) %>% 
          tk_tbl
        
        sets <- sets[1:(hrz1 - (hrz2 * lst_date_sq)),] %>% 
          dplyr::mutate(index = train_test[
            (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$index, 
            mk.price = train_test[
              (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$close) %>% 
          dplyr::rename(fc.price = `Point Forecast`) %>% 
          dplyr::select(index, mk.price, fc.price)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('forecast[', i, ']\n')
        
        print(sets %>% as.data.table)
        
        saveRDS(sets, paste0(
          dtr, 'data/fx/USDJPY/ets_', .model, '_', data_len, 
          '_', hrz1, '.', as_date(sets$index[1]), '.rds'))
        
        cat('\n')
        cat(i, '=', paste0('~/data/fx/USDJPY/ets_', .model, '_', 
                           data_len, '_', hrz1, '.', 
                           as_date(sets$index[1]), '.rds saved!\n'))
        cat('\n\n')
        rm(sets)
        
      } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
        
        
      } else if(i == length(timeID)) {
        
        
      } else {
        
        lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
        
        cat('\n')
        cat('===========================================\n')
        cat('train[', i, ']\n')
        
        print(train <- dsmp[(lst_sq - data_len + 1):lst_sq])
        ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('train_test[', i, ']\n')
        
        print(train_test <- dsmp[sq %in% ctr])
        
        sets <- train[, .(index, close)] %>% 
          tk_ts(frequency = hrz1) %>% 
          ets(model = .model) %>% 
          forecast(h = hrz1) %>% 
          tk_tbl %>% 
          dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                        mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
          dplyr::rename(fc.price = `Point Forecast`) %>% 
          dplyr::select(index, mk.price, fc.price)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('forecast[', i, ']\n')
        
        print(sets %>% as.data.table)
        
        saveRDS(sets, paste0(
          dtr, 'data/fx/USDJPY/ets_', .model, '_', data_len, 
          '_', hrz1, '.', as_date(sets$index[1]), '.rds'))
        
        cat('\n')
        cat(i, '=', paste0('~/data/fx/USDJPY/ets_', .model, '_', 
                           data_len, '_', hrz1, '.', 
                           as_date(sets$index[1]), '.rds saved!\n'))
        cat('\n\n')
        rm(sets)
      }
	  })
	  
	} else {
	   
	  
	}
  return(tmp)
}
```

Refer to above function or load below r function.

```{r}
## set all models provided by ets function.
ets.m <- c('AAN', 'AAZ', 'ANN', 'ANZ', 'AZN', 'AZZ', 'MAN', 'MAZ', 'MMN', 
            'MMZ', 'MNN', 'MNZ', 'MZN', 'MZZ', 'ZAN', 'ZAZ', 'ZMN', 'ZMZ', 
            'ZNN', 'ZNZ', 'ZZN', 'ZZZ')

source('function/tseas.R')
```

#### Wk >> Dy

I set the length of data as weekly (`5 days * 1440 mins = 7200 mins` minutes which is 5 trading days) to forecast `1440` minutes (`1440` minutes is a trading day).

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 7200 #last 7200  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 1440
hrz2 <- 1440

llply(ets.m, function(md) {
  tseas(timeID = timeID, dsmp, 
        data_len = data_len, hrz1 = hrz1, 
        hrz2 = hrz2, .model = md)
  })
```

#### Mn >> Dy

I set the length of data as monthly (`22 days * 1440 mins = 31680 mins` minutes which is 22 trading days) to forecast `1440` minutes (`1440` minutes is a trading day).

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 22 * 1440 #last 31680  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 1440
hrz2 <- 1440

llply(ets.m, function(md) {
  tseas(timeID = timeID, dsmp, 
        data_len = data_len, hrz1 = hrz1, 
        hrz2 = hrz2, .model = md)
  })
```

#### Qt >> Dy

I set the length of data as quarterly (`3 months * 22 days * 1440 mins = 95040 mins` minutes which is 66 trading days) to forecast `1440` minutes (`1440` minutes is a trading day).

#### Yr >> Dy

I set the length of data as yearly (`52 weeks * 5 days * 1440 mins = 374400 mins` minutes which is 260 trading days) to forecast `1440` minutes (`1440` minutes is a trading day).

### Weekly Seasonal Data

#### Modelling

```{r eval = FALSE}
## set all models provided by ets function.
ets.m <- c('AAN', 'AAZ', 'ANN', 'ANZ', 'AZN', 'AZZ', 'MAN', 'MAZ', 'MMN', 
            'MMZ', 'MNN', 'MNZ', 'MZN', 'MZZ', 'ZAN', 'ZAZ', 'ZMN', 'ZMZ', 
            'ZNN', 'ZNZ', 'ZZN', 'ZZZ')


tseas <- function(timeID, data = dsmp, data_len, 
                  hrz1 = c(1440, 7200), hrz2 = 1440, .model) {
	
	if(hrz1 == 1440) {
	  
	  tmp <- llply(1:length(timeID), function(i) {
	    if(i == 1) {
	      
	      cat('\n')
        cat('===========================================\n')
        cat('train[', i, ']\n')
        print(train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N])
        ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('train_test[', i, ']\n')
        
        print(train_test <- dsmp[sq %in% ctr])
        
        sets <- train[, .(index, close)] %>% 
          tk_ts(frequency = hrz1) %>% 
          ets(model = .model) %>% 
          forecast(h = hrz1) %>% 
          tk_tbl %>% 
          dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                        mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
          dplyr::rename(fc.price = `Point Forecast`) %>% 
          dplyr::select(index, mk.price, fc.price)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('forecast[', i, ']\n')
        
        print(sets %>% as.data.table)
        
        saveRDS(sets, paste0(
          dtr, 'data/fx/USDJPY/ets_', .model, '_', data_len, 
          '_', hrz1, '.', as_date(sets$index[1]), '.rds'))
        
        cat('\n')
        cat(i, '=', paste0('~/data/fx/USDJPY/ets_', .model, '_', 
                           data_len, '_', hrz1, '.', 
                           as_date(sets$index[1]), '.rds saved!\n'))
        cat('\n\n')
        rm(sets)
        
      } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
        
        
      } else if(i == length(timeID)) {
        
        
      } else  {
        
        lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
        
        cat('\n')
        cat('===========================================\n')
        cat('train[', i, ']\n')
        
        print(train <- dsmp[(lst_sq - data_len + 1):lst_sq])
        ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('train_test[', i, ']\n')
        
        print(train_test <- dsmp[sq %in% ctr])
        
        sets <- train[, .(index, close)] %>% 
          tk_ts(frequency = hrz1) %>% 
          ets(model = .model) %>% 
          forecast(h = hrz1) %>% 
          tk_tbl %>% 
          dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                        mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
          dplyr::rename(fc.price = `Point Forecast`) %>% 
          dplyr::select(index, mk.price, fc.price)
          
        cat('\n')
        cat('-------------------------------------------\n')
        cat('forecast[', i, ']\n')
        
        print(sets %>% as.data.table)
        
        saveRDS(sets, paste0(
          dtr, 'data/fx/USDJPY/ets_', .model, '_', data_len, 
          '_', hrz1, '.', as_date(sets$index[1]), '.rds'))
        
        cat('\n')
        cat(i, '=', paste0('~/data/fx/USDJPY/ets_', .model, '_', 
                           data_len, '_', hrz1, '.', 
                           as_date(sets$index[1]), '.rds saved!\n'))
        cat('\n\n')
        rm(sets)
      }
    })
	} else if(hrz1 == 7200) {
	  
	  tmp <- llply(1:length(timeID), function(i) {
	    
	    if(i == 1) {
	      
	      cat('\n')
        cat('===========================================\n')
        cat('train[', i, ']\n')
        print(train <- dsmp[date < timeID[i]][(.N - (data_len - 1)):.N])
        ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('train_test[', i, ']\n')
        
        print(train_test <- dsmp[sq %in% ctr])
        
        sets <- train[, .(index, close)] %>% 
          tk_ts(frequency = hrz1) %>% 
          ets(model = .model) %>% 
          forecast(h = hrz1) %>% 
          tk_tbl %>% 
          dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                        mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
          dplyr::rename(fc.price = `Point Forecast`) %>% 
          dplyr::select(index, mk.price, fc.price)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('forecast[', i, ']\n')
        
        print(sets %>% as.data.table)
        
        saveRDS(sets, paste0(
          dtr, 'data/fx/USDJPY/ets_', .model, '_', data_len, 
          '_', hrz1, '.', as_date(sets$index[1]), '.rds'))
        
        cat('\n')
        cat(i, '=', paste0('~/data/fx/USDJPY/ets_', .model, '_', 
                           data_len, '_', hrz1, '.', 
                           as_date(sets$index[1]), '.rds saved!\n'))
        cat('\n\n')
        rm(sets)
        
      } else if(i > (length(timeID) - hrz1/hrz2) & i != length(timeID)) {
        
        lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
        ## filter the length of forecasted data to fit with train_test data 
        ##   when the length of forecasted data more then length of test data.
        #lst_date <- timeID[(length(timeID) - (hrz1/hrz2)):length(timeID)]
        lst_date <- timeID[timeID >= timeID[i]]
        lst_date_sq <- grep(
          timeID[i], timeID[
            (length(timeID) - (hrz1/hrz2 - 1)):length(timeID)])
        
        cat('\n')
        cat('===========================================\n')
        cat('train[', i, ']\n')
        
        print(train <- dsmp[(lst_sq - data_len + 1):lst_sq])
        ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('train_test[', i, ']\n')
        
        print(train_test <- dsmp[sq %in% ctr])
        
        sets <- train[, .(index, close)] %>% 
          tk_ts(frequency = hrz1) %>% 
          ets(model = .model) %>% 
          forecast(h = hrz1) %>% 
          tk_tbl
        
        sets <- sets[1:(hrz1 - (hrz2 * lst_date_sq)),] %>% 
          dplyr::mutate(index = train_test[
            (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$index, 
            mk.price = train_test[
              (.N - (hrz1 - (hrz2 * lst_date_sq)) + 1):.N, ]$close) %>% 
          dplyr::rename(fc.price = `Point Forecast`) %>% 
          dplyr::select(index, mk.price, fc.price)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('forecast[', i, ']\n')
        
        print(sets %>% as.data.table)
        
        saveRDS(sets, paste0(
          dtr, 'data/fx/USDJPY/ets_', .model, '_', data_len, 
          '_', hrz1, '.', as_date(sets$index[1]), '.rds'))
        
        cat('\n')
        cat(i, '=', paste0('~/data/fx/USDJPY/ets_', .model, '_', 
                           data_len, '_', hrz1, '.', 
                           as_date(sets$index[1]), '.rds saved!\n'))
        cat('\n\n')
        rm(sets)
        
      } else if(i %in% seq(1, length(timeID), by = 6)[-1]) {
        
        
      } else if(i == length(timeID)) {
        
        
      } else {
        
        lst_sq <- dsmp[date < timeID[i],][.N]$sq + 1
        
        cat('\n')
        cat('===========================================\n')
        cat('train[', i, ']\n')
        
        print(train <- dsmp[(lst_sq - data_len + 1):lst_sq])
        ctr <- train$sq[1]:(range(train$sq)[2] + hrz1)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('train_test[', i, ']\n')
        
        print(train_test <- dsmp[sq %in% ctr])
        
        sets <- train[, .(index, close)] %>% 
          tk_ts(frequency = hrz1) %>% 
          ets(model = .model) %>% 
          forecast(h = hrz1) %>% 
          tk_tbl %>% 
          dplyr::mutate(index = train_test[(.N - hrz1 + 1):.N,]$index, 
                        mk.price = train_test[(.N - hrz1 + 1):.N,]$close) %>% 
          dplyr::rename(fc.price = `Point Forecast`) %>% 
          dplyr::select(index, mk.price, fc.price)
        
        cat('\n')
        cat('-------------------------------------------\n')
        cat('forecast[', i, ']\n')
        
        print(sets %>% as.data.table)
        
        saveRDS(sets, paste0(
          dtr, 'data/fx/USDJPY/ets_', .model, '_', data_len, 
          '_', hrz1, '.', as_date(sets$index[1]), '.rds'))
        
        cat('\n')
        cat(i, '=', paste0('~/data/fx/USDJPY/ets_', .model, '_', 
                           data_len, '_', hrz1, '.', 
                           as_date(sets$index[1]), '.rds saved!\n'))
        cat('\n\n')
        rm(sets)
      }
	  })
	  
	} else {
	   
	  
	}
  return(tmp)
}
```

Refer to above function or load below r function.

```{r}
## set all models provided by ets function.
if(!exists('ets.m')) {
  ets.m <- c('AAN', 'AAZ', 'ANN', 'ANZ', 'AZN', 'AZZ', 'MAN', 'MAZ', 'MMN', 
            'MMZ', 'MNN', 'MNZ', 'MZN', 'MZZ', 'ZAN', 'ZAZ', 'ZMN', 'ZMZ', 
            'ZNN', 'ZNZ', 'ZZN', 'ZZZ') }
if(!exists('tseas')) source('function/tseas.R')
```

#### Wk >> Wk

I set the length of data as weekly (`5 days * 1440 mins = 7200 mins` minutes which is 22 trading days) to forecast `7200` minutes (`7200` minutes is 5 trading day).

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 7200 #last 7200  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 7200
hrz2 <- 1440

llply(ets.m, function(md) {
  tseas(timeID = timeID, dsmp, 
        data_len = data_len, hrz1 = hrz1, 
        hrz2 = hrz2, .model = md)
  })
```

#### Mn >> Wk

I set the length of data as monthly (`22 days * 1440 mins = 31680 mins` minutes which is 22 trading days) to forecast `7200` minutes (`7200` minutes is 5 trading day).

#### Qt >> Wk

I set the length of data as quarterly (`3 months * 22 days * 1440 mins = 95040 mins` minutes which is 66 trading days) to forecast `7200` minutes (`7200` minutes is 5 trading day).

#### Yr >> Wk

I set the length of data as yearly (`52 weeks * 5 days * 1440 mins = 374400 mins` minutes which is 260 trading days) to forecast `7200` minutes (`7200` minutes is 5 trading day).

## Exponential `msts()` & `ets()`

### Daily Seasonal Data

#### Modelling

```{r eval = FALSE}
## set all models provided by ets function.
ets.m <- c('AAN', 'AAZ', 'ANN', 'ANZ', 'AZN', 'AZZ', 'MAN', 'MAZ', 'MMN', 
            'MMZ', 'MNN', 'MNZ', 'MZN', 'MZZ', 'ZAN', 'ZAZ', 'ZMN', 'ZMZ', 
            'ZNN', 'ZNZ', 'ZZN', 'ZZZ')

```

Refer to above function or load below r function.

```{r}
## set all models provided by ets function.
ets.m <- c('AAN', 'AAZ', 'ANN', 'ANZ', 'AZN', 'AZZ', 'MAN', 'MAZ', 'MMN', 
            'MMZ', 'MNN', 'MNZ', 'MZN', 'MZZ', 'ZAN', 'ZAZ', 'ZMN', 'ZMZ', 
            'ZNN', 'ZNZ', 'ZZN', 'ZZZ')

source('function/mstseas.R')
```

#### (Wk ∈ Mn) >> Dy

I set the length of data as monthly (`22 days * 1440 mins = 31680 mins` minutes which is 22 trading days), nested seasonal weekly (`5 days * 1440 mins = 7200 mins` minutes which is 5 trading days) and `1440` minutes (`1440` minutes is a trading day) to forecast `1440` minutes (`1440` minutes is a trading day).

- data observation length `22 days * 1440 mins = 31680 mins`
- seasonal `5 days * 1440 mins = 7200 mins`
- sub-seasonal `1440 mins`
- forecast `1440 mins`

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 7200 #last 7200  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 1440
hrz2 <- 1440

llply(ets.m, function(md) {
  mstseas(timeID = timeID, dsmp, 
        data_len = data_len, hrz1 = hrz1, 
        hrz2 = hrz2, .model = md)
  })
```

#### (Wk ∈ Qt) >> Dy

I set the length of data as quarterly (`3 months * 22 days * 1440 mins = 95040 mins` minutes which is 66 trading days), nested seasonal weekly (`5 days * 1440 mins = 7200 mins` minutes which is 5 trading days) and `1440` minutes (`1440` minutes is a trading day) to forecast `1440` minutes (`1440` minutes is a trading day).

- data observation length `3 months * 22 days * 1440 mins = 95040 mins`
- seasonal `5 days * 1440 mins = 7200 mins`
- sub-seasonal `1440 mins`
- forecast `1440 mins`

#### (Wk ∈ Yr) >> Dy

I set the length of data as yearly (`52 weeks * 5 days * 1440 mins = 374400 mins` minutes which is 260 trading days), nested seasonal weekly (`5 days * 1440 mins = 7200 mins` minutes which is 5 trading days) and `1440` minutes (`1440` minutes is a trading day) to forecast `1440` minutes (`1440` minutes is a trading day).

- data observation length `52 weeks * 5 days * 1440 mins = 374400 mins`
- seasonal `5 days * 1440 mins = 7200 mins`
- sub-seasonal `1440 mins`
- forecast `1440 mins`

#### (Mn ∈ Qt) >> Dy

I set the length of data as quarterly (`3 months * 22 days * 1440 mins = 95040 mins` minutes which is 66 trading days), nested seasonal monthly (`22 days * 1440 mins = 31680 mins` minutes which is 22 trading days) and `1440` minutes (`1440` minutes is a trading day) to forecast `1440` minutes (`1440` minutes is a trading day).

- data observation length `3 months * 22 days * 1440 mins = 95040 mins`
- seasonal `22 days * 1440 mins = 31680 mins`
- sub-seasonal `1440 mins`
- forecast `1440 mins`

### Weekly Seasonal Data

#### Modelling

```{r eval = FALSE}
## set all models provided by ets function.
ets.m <- c('AAN', 'AAZ', 'ANN', 'ANZ', 'AZN', 'AZZ', 'MAN', 'MAZ', 'MMN', 
            'MMZ', 'MNN', 'MNZ', 'MZN', 'MZZ', 'ZAN', 'ZAZ', 'ZMN', 'ZMZ', 
            'ZNN', 'ZNZ', 'ZZN', 'ZZZ')

```

Refer to above function or load below r function.

```{r}
## set all models provided by ets function.
ets.m <- c('AAN', 'AAZ', 'ANN', 'ANZ', 'AZN', 'AZZ', 'MAN', 'MAZ', 'MMN', 
            'MMZ', 'MNN', 'MNZ', 'MZN', 'MZZ', 'ZAN', 'ZAZ', 'ZMN', 'ZMZ', 
            'ZNN', 'ZNZ', 'ZZN', 'ZZZ')

source('function/mstseas.R')
```

#### (Wk ∈ Mn) >> Wk

I set the length of data as monthly (`22 days * 1440 mins = 31680 mins` minutes which is 22 trading days), nested seasonal weekly (`5 days * 1440 mins = 7200 mins` minutes which is 5 trading days) and `1440` minutes (`1440` minutes is a trading day) to forecast `7200` minutes (`7200` minutes is 5 trading day).

- data observation length `22 days * 1440 mins = 31680 mins`
- seasonal `5 days * 1440 mins = 7200 mins`
- sub-seasonal `1440 mins`
- forecast `7200 mins`

```{r, eval = FALSE}
# --------- eval=FALSE ---------
timeID <- unique(dsmp$date)
bse <- dsmp[year == 2016]$date[1] #"2016-01-04" #1st trading date in 2nd year
timeID %<>% .[. >= bse]
#timeID %<>% .[. >= as_date('2016-01-04')]
data_len <- 7200 #last 7200  observations dsmp[(.N - (data_len - 1)):.N]
hrz1 <- 1440
hrz2 <- 1440

llply(ets.m, function(md) {
  mstseas(timeID = timeID, dsmp, 
        data_len = data_len, hrz1 = hrz1, 
        hrz2 = hrz2, .model = md)
  })
```

#### (Wk ∈ Qt) >> Wk

I set the length of data as quarterly (`3 months * 22 days * 1440 mins = 95040 mins` minutes which is 66 trading days), nested seasonal weekly (`5 days * 1440 mins = 7200 mins` minutes which is 5 trading days) and `1440` minutes (`1440` minutes is a trading day) to forecast `7200` minutes (`7200` minutes is 5 trading day).

- data observation length `3 months * 22 days * 1440 mins = 95040 mins`
- seasonal `5 days * 1440 mins = 7200 mins`
- sub-seasonal `1440 mins`
- forecast `7200 mins`

#### (Wk ∈ Yr) >> Wk

I set the length of data as yearly (`52 weeks * 5 days * 1440 mins = 374400 mins` minutes which is 260 trading days), nested seasonal weekly (`5 days * 1440 mins = 7200 mins` minutes which is 5 trading days) and `1440` minutes (`1440` minutes is a trading day) to forecast `7200` minutes (`7200` minutes is 5 trading day).

- data observation length `52 weeks * 5 days * 1440 mins = 374400 mins`
- seasonal `5 days * 1440 mins = 7200 mins`
- sub-seasonal `1440 mins`
- forecast `7200 mins`

#### (Mn ∈ Qt) >> Wk

I set the length of data as quarterly (`3 months * 22 days * 1440 mins = 95040 mins` minutes which is 66 trading days), nested seasonal monthly (`22 days * 1440 mins = 31680 mins` minutes which is 22 trading days) and `1440` minutes (`1440` minutes is a trading day) to forecast `7200` minutes (`7200` minutes is 5 trading day).

- data observation length `3 months * 22 days * 1440 mins = 95040 mins`
- seasonal `22 days * 1440 mins = 31680 mins`
- sub-seasonal `1440 mins`
- forecast `7200 mins`

# Comparison

## 1 min per unit

### Seasonal `ts` and `msts`

Here I read the saved models.

```{r, eval=FALSE, warning = FALSE, message = FALSE}
## Get all files.
fls <- paste0(dtr, 'data/fx/USDJPY/') %>% 
  list.files(., pattern = '^ts_|^ets_|^msts_')

fls_pth <- paste0(dtr, 'data/fx/USDJPY/', fls)

mds <- ldply(1:length(fls), function(i) {
    
    nms <- fls[i] %>% 
        str_replace_all('.rds', '') %>% 
        str_split('_|\\.') %>% 
        .[[1]]
    names(nms) <- c('model', 'sub_model', 'data_min', 'fc_min', 'date')
    datset2 <- t(nms) %>% 
      data.frame %>% 
      mutate(model =factor(model), sub_model = factor(sub_model), 
             data_min = as.numeric(data_min), 
             fc_min = as.numeric(fc_min), date = as_date(date))
    
    datset <- read_rds(fls_pth[i])
    
    res <- tibble(datset2, datset) %>% 
      dplyr::select(index, model, sub_model, data_min, 
                    fc_min, date, mk.price, fc.price)
    
    return(res)
    
}) %>% 
  as_tibble

```

```{r message=FALSE, warning=FALSE}
mds <- read_rds('data/fx/USDJPY/seasonal_m1.rds')
```

#### Line Graph & Trend

Below graph shows the forecast price and actual price.

##### Overview

```{r, eval = FALSE, warning = FALSE, results = 'asis'}
grph <- seasonal_m1 %>% 
  tidyr::unite(Model, Model:Period) %>% 
  data.table
prc <- unique(grph[, .(index, open, high, low, close)])
prc <- prc[, Model := 'Market.Price'][]
grph <- grph[, (c('open', 'high', 'low', 'close')) := NULL]
names(grph) <- c('index', 'Model', 'open', 'high', 'low', 'close')
grph <- rbind(grph, prc)
grph <- data.table(grph)[order(index)]
rm(prc)

## save dataset in data.table format
saveRDS(grph, 'data/fx/USDJPY/grph.rds')
# fwrite(data.table(grph), 'data/fx/USDJPY/grph.csv')
# write.table(data.table(grph), 'data/fx/USDJPY/grph.txt')

## https://rstudio-pubs-static.s3.amazonaws.com/31702_9c22e3d1a0c44968a4a1f9656f1800ab.html
grph_json <- rjson::toJSON(grph)
write(grph_json, 'data/fx/USDJPY/grph_json.json')

#grph_json <- fromJSON('data/fx/USDJPY/grph_json.json')
```

```{r, warning = FALSE, results = 'asis'}
grph <- readRDS('data/fx/USDJPY/grph.rds')
data.frame(grph)[c(1:5, (nrow(grph)-5):nrow(grph)),] %>% 
  kbl('html', caption = 'Data Sample', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'LightSlateGrey') %>% 
  column_spec(3, background = 'DarkGrey') %>% 
  column_spec(5, background = 'DarkGrey') %>% 
  column_spec(7, background = 'DarkGrey') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')
```

the dataset above has `r paste(dim(grph), 'x')` dimensions.

```{r, eval = FALSE, warning = FALSE, message = FALSE, results = 'asis'}
## https://plotly.com/r/embedding-graphs-in-rmarkdown
## https://stackoverflow.com/questions/25186022/embedding-plotly-output-in-r-markdown/25192691
## 
fig <- plot_ly(grph, x = ~index, y = ~open, color = ~Model) 
fig <- fig %>% add_lines()
fig
```

##### Open Price

```{r, eval = FALSE, warning = FALSE, results = 'asis'}
## ------------ eval = FALSE -------------------
## Due to high volume dataset and heavily ploting, here I ommit it.
grph %>% 
    group_by(Model) %>% 
    e_charts(x = index) %>% 
    e_line(open.Point.Forecast, smooth = TRUE) %>% 
  e_datazoom(
    type = 'slider', 
    toolbox = FALSE,
    bottom = -5) %>% 
  e_tooltip() %>% 
  e_title(text = 'Model', subtext = 'open.Point.Forecast', left = 'center') %>% 
  e_axis_labels(x = 'index', y = 'open.Point.Forecast') %>%
  e_x_axis(index, axisPointer = list(show = TRUE)) %>% 
  e_legend(
    orient = 'vertical', 
    type = c('scroll'), 
    #selectedMode = 'multiple', #https://echarts.apache.org/en/option.html#legend
    #selected = list('Model'), 
    left = 0, top = 80) %>% 
  e_grid(left = 150, top = 90) %>% 
  #e_theme('shine') %>% 
  e_toolbox_feature('saveAsImage', title = 'Screenshot')
```

```{r, eval = FALSE, warning = FALSE, results = 'asis'}
## ggthemes
palettes1 <- ggthemes_data[['tableau']][['color-palettes']][['ordered-sequential']]
## https://github.com/BTJ01/ggthemes/blob/master/inst/examples/ex-scale_color_tableau.R
palettes2 <- ggthemes_data[["tableau"]][["color-palettes"]][["regular"]]

## -------------------------------
## ggthemr
## https://www.shanelynn.ie/themes-and-colours-for-r-ggplots-with-ggthemr/

#tableau_colours <- c('#1F77B4', '#FF7F0E', '#2CA02C', '#D62728', '#9467BD', '#8C564B', '#CFECF9', '#7F7F7F', '#BCBD22', '#17BECF')
tableau_colours <- palettes2$`Tableau 20`$value
names(tableau_colours) <- palettes2$`Tableau 20`$name

#names(tableau_colours) <- unique(grph$Model)

## https://colorbrewer2.org/#type=qualitative&scheme=Paired&n=12
#tableau_colours <- c('#a6cee3', '#1f78b4', '#b2df8a', '#33a02c', '#fb9a99', '#e31a1c', '#fdbf6f', '#ff7f00', '#cab2d6', '#6a3d9a', '#ffff99', '#b15928')

# you have to add a colour at the start of your palette for outlining boxes, we'll use a grey:
#tableau_colours <- c("#555555", tableau_colours)
# remove previous effects:
ggthemr_reset()

# Define colours for your figures with define_palette
tableau <- define_palette(
    swatch = tableau_colours, # colours for plotting points and bars
    ## https://stackoverflow.com/questions/7014387/whats-the-difference-between-1l-and-1
    gradient = c(lower = tableau_colours[1L], upper = tableau_colours[length(tableau_colours)]), #upper and lower colours for continuous colours
    #background = "#EEEEEE" #defining a grey-ish background 
)
# set the theme for your figures:
ggthemr(tableau)

## ------------------------
## https://stackoverflow.com/questions/34601194/change-colours-to-defined-palette-for-ggplot-objects
change_colours <- function(p, palette) {
  n <- nlevels(p$data[[deparse(p$mapping$group)]])
  tryCatch(as.character(palette), 
           abnor=function(e) stop('palette should be a vector of colours', call.=FALSE))
  if(n > length(palette)) stop('Not enough colours in palette.')
  pal <- function(n) palette[seq_len(n)]
  p + theme_light() + discrete_scale('colour', 'foo', pal)
}
```

```{r, warning = FALSE, results = 'asis'}
md1 <- sort(unique(grph$Model)[str_detect(unique(grph$Model), '^ts_')])
md2 <- unique(grph$Model)[!unique(grph$Model) %in% md1]
```

```{r, eval = FALSE, warning = FALSE, results = 'asis'}
## https://www.r-graph-gallery.com/line-chart-several-groups-ggplot2.html
p1a <- grph[Model %in% md1] %>% 
  ggplot(aes(x = index, y = open, group = Model, color = Model)) + 
  geom_line() + 
  #scale_colour_gradient2_tableau(palette = names(palettes)[1]) + #first palettes list in name
  #scale_color_viridis(discrete = TRUE) + 
  labs(title = '1 min Open Price Forecasting', 
       subtitle = paste('From', range(unique(grph$index))[1L], 'to', range(unique(grph$index))[2L]), 
       caption = "Data source: fxcm") + 
  ylab('Exchange Rates USD/JPY') + 
  theme_economist() + 
  #scale_color_economist() + 
  ##scale_fill_manual(values = tableau_colours) + 
  #scale_color_brewer(tableau_colours) + 
  #scale_color_jcolors(palette = palettes2$`Tableau 20`$value) + #choose color set among palettes
  #theme(axis.text.x = element_text(hjust = c(0, 0.5, 0.5, 0.5, 1))) + 
  theme(legend.position = 'right')

#p1a
ggplotly(p1a)
```

Due to large size, here I do not plot the graph. 

```{r eval = FALSE, include = FALSE}
rm(p1a)
```

```{r, eval = FALSE, warning = FALSE, results = 'asis'}
## https://www.r-graph-gallery.com/line-chart-several-groups-ggplot2.html
p1b <- grph[Model %in% md2] %>% 
  ggplot(aes(x = index, y = open, group = Model, color = Model)) + 
  geom_line() + 
  #scale_colour_gradient2_tableau(palette = names(palettes)[1]) + #first palettes list in name
  #scale_color_viridis(discrete = TRUE) + 
  labs(title = '1 min Open Price Forecasting', 
       subtitle = paste('From', range(unique(grph$index))[1L], 'to', range(unique(grph$index))[2L]), 
       caption = "Data source: fxcm") + 
  ylab('Exchange Rates USD/JPY') + 
  theme_economist() + 
  #scale_color_economist() + 
  ##scale_fill_manual(values = tableau_colours) + 
  #scale_color_brewer(tableau_colours) + 
  #scale_color_jcolors(palette = palettes2$`Tableau 20`$value) + #choose color set among palettes
  #theme(axis.text.x = element_text(hjust = c(0, 0.5, 0.5, 0.5, 1))) + 
  theme(legend.position = 'right')

#p1b
ggplotly(p1b)
```

Due to large size, here I do not plot the graph. 

```{r eval = FALSE, include = FALSE}
rm(p1b)
```

##### High Price

```{r, eval = FALSE, warning = FALSE, results = 'asis'}
## https://www.r-graph-gallery.com/line-chart-several-groups-ggplot2.html
p2a <- grph[Model %in% md1] %>% 
  ggplot(aes(x = index, y = high, group = Model, color = Model)) + 
  geom_line() + 
  #scale_color_viridis(discrete = TRUE) + 
  labs(title = '1 min High Price Forecasting', 
       subtitle = paste('From', range(unique(grph$index))[1L], 'to', range(unique(grph$index))[2L]), 
       caption = "Data source: fxcm") + 
  ylab('Exchange Rates USD/JPY') + 
  theme_economist() + 
  #scale_color_economist() + 
  #theme(axis.text.x = element_text(hjust = c(0, 0.5, 0.5, 0.5, 1))) + 
  theme(legend.position = 'right')

#p2a
ggplotly(p2a)
```

Due to large size, here I do not plot the graph. 

```{r eval = FALSE, include = FALSE}
rm(p2a)
```

```{r, eval = FALSE, warning = FALSE, results = 'asis'}
## https://www.r-graph-gallery.com/line-chart-several-groups-ggplot2.html
p2b <- grph[Model %in% md2] %>% 
  ggplot(aes(x = index, y = high, group = Model, color = Model)) + 
  geom_line() + 
  #scale_color_viridis(discrete = TRUE) + 
  labs(title = '1 min High Price Forecasting', 
       subtitle = paste('From', range(unique(grph$index))[1L], 'to', range(unique(grph$index))[2L]), 
       caption = "Data source: fxcm") + 
  ylab('Exchange Rates USD/JPY') + 
  theme_economist() + 
  #scale_color_economist() + 
  #theme(axis.text.x = element_text(hjust = c(0, 0.5, 0.5, 0.5, 1))) + 
  theme(legend.position = 'right')

#p2b
ggplotly(p2b)
```

Due to large size, here I do not plot the graph. 

```{r eval = FALSE, include = FALSE}
rm(p2b)
```

##### Low Price

```{r, eval = FALSE, warning = FALSE, results = 'asis'}
## https://www.r-graph-gallery.com/line-chart-several-groups-ggplot2.html
p3a <- grph[Model %in% md1] %>% 
  ggplot(aes(x = index, y = low, group = Model, color = Model)) + 
  geom_line() + 
  #scale_color_viridis(discrete = TRUE) + 
  labs(title = '1 min Low Price Forecasting', 
       subtitle = paste('From', range(unique(grph$index))[1], 'to', range(unique(grph$index))[2]), 
       caption = "Data source: fxcm") + 
  ylab('Exchange Rates USD/JPY') + 
  theme_economist() + 
  #scale_color_economist() + 
  #theme(axis.text.x = element_text(hjust = c(0, 0.5, 0.5, 0.5, 1))) + 
  theme(legend.position = 'right')

#p3a
ggplotly(p3a)
```

Due to large size, here I do not plot the graph. 

```{r eval = FALSE, include = FALSE}
rm(p3a)
```

```{r, eval = FALSE, warning = FALSE, results = 'asis'}
## https://www.r-graph-gallery.com/line-chart-several-groups-ggplot2.html
p3b <- grph[Model %in% md2] %>% 
  ggplot(aes(x = index, y = low, group = Model, color = Model)) + 
  geom_line() + 
  #scale_color_viridis(discrete = TRUE) + 
  labs(title = '1 min Low Price Forecasting', 
       subtitle = paste('From', range(unique(grph$index))[1], 'to', range(unique(grph$index))[2]), 
       caption = "Data source: fxcm") + 
  ylab('Exchange Rates USD/JPY') + 
  theme_economist() + 
  #scale_color_economist() + 
  #theme(axis.text.x = element_text(hjust = c(0, 0.5, 0.5, 0.5, 1))) + 
  theme(legend.position = 'right')

#p3b
ggplotly(p3b)
```

Due to large size, here I do not plot the graph. 

```{r eval = FALSE, include = FALSE}
rm(p3b)
```

##### Close Price

```{r, eval = FALSE, warning = FALSE, results = 'asis'}
## https://www.r-graph-gallery.com/line-chart-several-groups-ggplot2.html
p4a <- grph[Model %in% md1] %>% 
  ggplot(aes(x = index, y = close, group = Model, color = Model)) + 
  geom_line() + 
  #scale_color_viridis(discrete = TRUE) + 
  labs(title = '1 min Close Price Forecasting', 
       subtitle = paste('From', range(unique(grph$index))[1], 'to', range(unique(grph$index))[2]), 
       caption = "Data source: fxcm") + 
  ylab('Exchange Rates USD/JPY') + 
  theme_economist() + 
  #scale_color_economist() + 
  #theme(axis.text.x = element_text(hjust = c(0, 0.5, 0.5, 0.5, 1))) + 
  theme(legend.position = 'right')

p4a
ggplotly(p4a)
```

Due to large size, here I do not plot the graph. 

```{r eval = FALSE, include = FALSE}
rm(p4a)
```

```{r, eval = FALSE, warning = FALSE, results = 'asis'}
## https://www.r-graph-gallery.com/line-chart-several-groups-ggplot2.html
p4b <- grph[Model %in% md2] %>% 
  ggplot(aes(x = index, y = close, group = Model, color = Model)) + 
  geom_line() + 
  #scale_color_viridis(discrete = TRUE) + 
  labs(title = '1 min Close Price Forecasting', 
       subtitle = paste('From', range(unique(grph$index))[1], 'to', range(unique(grph$index))[2]), 
       caption = "Data source: fxcm") + 
  ylab('Exchange Rates USD/JPY') + 
  theme_economist() + 
  #scale_color_economist() + 
  #theme(axis.text.x = element_text(hjust = c(0, 0.5, 0.5, 0.5, 1))) + 
  theme(legend.position = 'right')

p4b
ggplotly(p4b)
```

Due to large size, here I do not plot the graph. 

```{r eval = FALSE, include = FALSE}
rm(p4b)
```

#### MSE Table

Below table compares the models.

```{r, warning = FALSE, message = FALSE}
mse1 <- seasonal_m1 %>% 
  ddply(.(Model, Period), summarise, 
        MSE.open = mean((open.Point.Forecast - open)^2, na.rm=TRUE), 
        MSE.high = mean((high.Point.Forecast - high)^2, na.rm=TRUE), 
        MSE.low = mean((low.Point.Forecast - low)^2, na.rm=TRUE), 
        MSE.close = mean((close.Point.Forecast - close)^2, na.rm=TRUE), 
        MSE.HLC = (MSE.high + MSE.low + MSE.close)/3, 
        MSE.OHLC = (MSE.open + MSE.high + MSE.low + MSE.close)/4, 
        n = length(index)) %>% 
  as_tibble
```

```{r, warning = FALSE, message = FALSE, results='asis'}
tb6 <- mse1 %>% 
  dplyr::mutate(
    MSE.open = ifelse(
      rank(MSE.open) <= 3, 
      cell_spec(
        paste0(round(MSE.open, 7), ' (rank: ', sprintf('%1.f', rank(MSE.open)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(MSE.open, 7), ' (rank: ', sprintf('%1.f', rank(MSE.open)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    MSE.high = ifelse(
      rank(MSE.high) <= 3, 
      cell_spec(
        paste0(round(MSE.high, 7), ' (rank: ', sprintf('%1.f', rank(MSE.high)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(MSE.high, 7), ' (rank: ', sprintf('%1.f', rank(MSE.high)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    MSE.low = ifelse(
      rank(MSE.low) <= 3, 
      cell_spec(
        paste0(round(MSE.low, 7), ' (rank: ', sprintf('%1.f', rank(MSE.low)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(MSE.low, 7), ' (rank: ', sprintf('%1.f', rank(MSE.low)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    MSE.close = ifelse(
      rank(MSE.close) <= 3, 
      cell_spec(
        paste0(round(MSE.close, 7), ' (rank: ', sprintf('%1.f', rank(MSE.close)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(MSE.close, 7), ' (rank: ', sprintf('%1.f', rank(MSE.close)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    MSE.HLC = ifelse(
      rank(MSE.HLC) <= 3, 
      cell_spec(
        paste0(round(MSE.HLC, 7), ' (rank: ', sprintf('%1.f', rank(MSE.HLC)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(MSE.HLC, 7), ' (rank: ', sprintf('%1.f', rank(MSE.HLC)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    MSE.OHLC = ifelse(
      rank(MSE.OHLC) <= 3, 
      cell_spec(
        paste0(round(MSE.OHLC, 7), ' (rank: ', sprintf('%1.f', rank(MSE.OHLC)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(MSE.OHLC, 7), ' (rank: ', sprintf('%1.f', rank(MSE.OHLC)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'MSE of Seasonal Daily 1440 minutes ETS Model (Accumulated Period from Weekly)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  column_spec(3, background = 'Gainsboro') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>% 
  column_spec(7, background = 'Gainsboro') %>%  
  column_spec(8, background = 'LightGray') %>% 
  column_spec(9, background = 'LightSlateGrey') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb6
```

```{r include = FALSE}
rm(mse1, tb6)
```

from above models we know the βest model.

### Interday Models

Here I summarize 1440 of 1 min data to be 1 day and choose the best fitted model. Below table compares the models.

```{r, eval = FALSE, message = FALSE, warning = FALSE, results = 'asis'}
# mse2 <- seasonal_m1 %>% 
#   ddply(.(Model, Period, index), summarise, 
#         MSE.open = mean((open.Point.Forecast - open)^2, na.rm=TRUE), 
#         MSE.high = mean((high.Point.Forecast - high)^2, na.rm=TRUE), 
#         MSE.low = mean((low.Point.Forecast - low)^2, na.rm=TRUE), 
#         MSE.close = mean((close.Point.Forecast - close)^2, na.rm=TRUE), 
#         MSE.HLC = (MSE.high + MSE.low + MSE.close)/3, 
#         MSE.OHLC = (MSE.open + MSE.high + MSE.low + MSE.close)/4, 
#         n = length(index)) %>% 
#   as_tibble

## https://tysonbarrett.com/jekyll/update/2019/10/06/datatable_memory/
## http://brooksandrew.github.io/simpleblog/articles/advanced-data-table/
seasonal_m1 <- data.table(seasonal_m1)
setorder(seasonal_m1, index)

open.accr <- seasonal_m1[, {
  open = open
  open.Point.Forecast = open.Point.Forecast
  .SD[, .(.N, open.mape = MLmetrics::MAPE(y_true = open, open.Point.Forecast), 
          open.smape = Metrics::smape(actual = open, predicted = open.Point.Forecast), 
          open.mse = MLmetrics::MSE(y_true = open, open.Point.Forecast), 
          open.rmse = MLmetrics::RMSE(y_true = open, y_pred = open.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

saveRDS(open.accr, 'data/fx/USDJPY/open.accr.rds')

high.accr <- seasonal_m1[, {
  high = high
  high.Point.Forecast = high.Point.Forecast
  .SD[, .(.N, high.mape = MLmetrics::MAPE(y_true = high, high.Point.Forecast), 
          high.smape = Metrics::smape(actual = high, predicted = high.Point.Forecast), 
          high.mse = MLmetrics::MSE(y_true = high, high.Point.Forecast), 
          high.rmse = MLmetrics::RMSE(y_true = high, high.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

low.accr <- seasonal_m1[, {
  low = low
  low.Point.Forecast = low.Point.Forecast
  .SD[, .(.N, low.mape = MLmetrics::MAPE(y_true = low, low.Point.Forecast), 
          low.smape = Metrics::smape(actual = low, predicted = low.Point.Forecast), 
          low.mse = MLmetrics::MSE(y_true = low, low.Point.Forecast), 
          low.rmse = MLmetrics::RMSE(y_true = low, y_pred = low.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

close.accr <- seasonal_m1[, {
  close = close
  close.Point.Forecast = close.Point.Forecast
  .SD[, .(.N, close.mape = MLmetrics::MAPE(y_true = close, close.Point.Forecast), 
          close.smape = Metrics::smape(actual = close, predicted = close.Point.Forecast), 
          close.mse = MLmetrics::MSE(y_true = close, close.Point.Forecast), 
          close.rmse = MLmetrics::RMSE(y_true = close, y_pred = close.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]
```

```{r, eval = FALSE, warning = FALSE, message = FALSE, results = 'asis'}
open.sm <- open.accr[, list(open.mape = mean(open.mape), 
                            open.smape = mean(open.smape), 
                            open.mse = mean(open.mse), 
                            open.rmse = mean(open.rmse)), 
                       by=.(Model, Period)]

high.sm <- high.accr[, list(high.mape = mean(high.mape), 
                            high.smape = mean(high.smape), 
                            high.mse = mean(high.mse), 
                            high.rmse = mean(high.rmse)), 
                       by=.(Model, Period)]

low.sm <- low.accr[, list(low.mape = mean(low.mape), 
                          low.smape = mean(low.smape), 
                          low.mse = mean(low.mse), 
                          low.rmse = mean(low.rmse)), 
                       by=.(Model, Period)]

close.sm <- close.accr[, list(close.mape = mean(close.mape), 
                              close.smape = mean(close.smape), 
                              close.mse = mean(close.mse), 
                              close.rmse = mean(close.rmse)), 
                       by=.(Model, Period)]

daily.sm <- join_all(list(open.sm, high.sm, low.sm, close.sm)) %>% 
  tibble

saveRDS(daily.sm, 'data/fx/USDJPY/best_m.rds')
rm(open.accr, high.accr, low.accr, close.accr)
rm(open.sm, high.sm, low.sm, close.sm)
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
open.accr <- readRDS('data/fx/USDJPY/open.accr.rds')

data.frame(open.accr)[c(1:5, (nrow(open.accr)-5):nrow(open.accr)),] %>% 
  kbl('html', caption = 'Data Sample', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  ## https://jrnold.github.io/ggthemes/reference/tableau_color_pal.html
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = '#4E79A7') %>% 
  column_spec(2, background = 'CornflowerBlue') %>% 
  column_spec(3, background = 'CornflowerBlue') %>% 
  column_spec(4, background = '#5b65a7') %>% 
  column_spec(5, background = '#A0CBE8') %>% 
  column_spec(6, background = 'DarkGrey') %>% 
  column_spec(8, background = 'DarkGrey') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')
```

From above table, we can know the models with `7200` has more observations due to using `7200` observations per forecast day.

#### Open Price

```{r, warning = FALSE, message = FALSE, results = 'asis'}
daily.sm <- readRDS('data/fx/USDJPY/best_m.rds')

tb7 <- daily.sm %>% 
  dplyr::select(contains(c('Model', 'Period', 'open'))) %>% 
  dplyr::mutate(
    open.mape = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.smape = ifelse(
      rank(open.smape) <= 3, 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mse = ifelse(
      rank(open.mse) <= 3, 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.rmse = ifelse(
      rank(open.rmse) <= 3, 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min Open Price Summarised to 1 Day per Unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  column_spec(3, background = 'Gainsboro') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>%   
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb7
```

```{r include = FALSE}
rm(tb7)
```

#### High Price

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb8 <- daily.sm %>% 
  dplyr::select(contains(c('Model', 'Period', 'high'))) %>% 
  dplyr::mutate(
    high.mape = ifelse(
      rank(high.mape) <= 3, 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.smape = ifelse(
      rank(high.smape) <= 3, 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.mse = ifelse(
      rank(high.mse) <= 3, 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.rmse = ifelse(
      rank(high.rmse) <= 3, 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min High Price Summarised to 1 Day per Unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  column_spec(3, background = 'Gainsboro') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>%   
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb8
```

```{r include = FALSE}
rm(tb8)
```

#### Low Price

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb9 <- daily.sm %>% 
  dplyr::select(contains(c('Model', 'Period', 'low'))) %>% 
  dplyr::mutate(
    low.mape = ifelse(
      rank(low.mape) <= 3, 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.smape = ifelse(
      rank(low.smape) <= 3, 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.mse = ifelse(
      rank(low.mse) <= 3, 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.rmse = ifelse(
      rank(low.rmse) <= 3, 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min Open Price Summarised to 1 Day per Unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  column_spec(3, background = 'Gainsboro') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>%   
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb9
```

```{r include = FALSE}
rm(tb9)
```

#### Close Price

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb10 <- daily.sm %>% 
  dplyr::select(contains(c('Model', 'Period', 'close'))) %>% 
  dplyr::mutate(
    close.mape = ifelse(
      rank(close.mape) <= 3, 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.smape = ifelse(
      rank(close.smape) <= 3, 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.mse = ifelse(
      rank(close.mse) <= 3, 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.rmse = ifelse(
      rank(close.rmse) <= 3, 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min Close Price Summarised to 1 Day per Unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  column_spec(3, background = 'Gainsboro') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>%   
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb10
```

```{r include = FALSE}
rm(tb10)
```

#### Summary

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb11 <- daily.sm %>% 
  dplyr::mutate(
    open.mape = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.smape = ifelse(
      rank(open.smape) <= 3, 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mse = ifelse(
      rank(open.mse) <= 3, 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.rmse = ifelse(
      rank(open.rmse) <= 3, 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    high.mape = ifelse(
      rank(high.mape) <= 3, 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.smape = ifelse(
      rank(high.smape) <= 3, 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.mse = ifelse(
      rank(high.mse) <= 3, 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.rmse = ifelse(
      rank(high.rmse) <= 3, 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    low.mape = ifelse(
      rank(low.mape) <= 3, 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.smape = ifelse(
      rank(low.smape) <= 3, 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.mse = ifelse(
      rank(low.mse) <= 3, 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.rmse = ifelse(
      rank(low.rmse) <= 3, 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    close.mape = ifelse(
      rank(close.mape) <= 3, 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.smape = ifelse(
      rank(close.smape) <= 3, 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.mse = ifelse(
      rank(close.mse) <= 3, 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.rmse = ifelse(
      rank(close.rmse) <= 3, 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min summarised to 1 day per unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  #column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(3, background = 'LightGray') %>% 
  column_spec(4, background = 'Gainsboro') %>% 
  column_spec(5, background = 'LightGray') %>%   
  column_spec(6, background = 'Gainsboro') %>% 
  column_spec(7, background = 'LightGray') %>% 
  column_spec(8, background = 'Gainsboro') %>% 
  column_spec(9, background = 'LightGray') %>%   
  column_spec(10, background = 'Gainsboro') %>% 
  column_spec(11, background = 'LightGray') %>% 
  column_spec(12, background = 'Gainsboro') %>% 
  column_spec(13, background = 'LightGray') %>%   
  column_spec(14, background = 'Gainsboro') %>% 
  column_spec(15, background = 'LightGray') %>% 
  column_spec(16, background = 'Gainsboro') %>% 
  column_spec(17, background = 'LightGray') %>%   
  column_spec(18, background = 'Gainsboro') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb11
```

```{r include = FALSE}
rm(daily.sm, tb11)
```

Above table summarized the daily `mape`, `smape`, `mse` and `rmse` values and then summarized again the models (which is nested summarize <span style='color:red'>due to daily settlement</span>), we can interpret from above table :

- Weekly or `7200 mins` length's dataset with `msts(seasonal.periods = c(1440, 7200)) %>% tbats %>% forecast(h = 1440)`.
- Quarterly length's dataset with `tk_ts(frequency = 1440) %>% forecast(h=1440)`.
- Annum length's dataset with `tk_ts(frequency = 1440) %>% forecast(h=1440)`.

### Miscellaneous

#### Best Model

```{r, eval = FALSE, warning = FALSE, message = FALSE, results = 'asis'}
#best_model <- seasonal_m1 %>% 
#    ddply(.(Model, Period), summarize, 
#        mape = MLmetrics::MAPE(y_true = open, open.Point.Forecast), 
#        smape = Metrics::smape(actual = open, predicted = open.Point.Forecast), 
#        mse = MLmetrics::MSE(y_true = open, open.Point.Forecast), 
#        rmse = MLmetrics::RMSE(y_true = open, y_pred = open.Point.Forecast))

## https://tysonbarrett.com/jekyll/update/2019/10/06/datatable_memory/
## http://brooksandrew.github.io/simpleblog/articles/advanced-data-table/
if(!is.data.table(seasonal_m1)) seasonal_m1 <- data.table(seasonal_m1)
setorder(seasonal_m1, index)

m.op <- seasonal_m1[, {
  open = open
  open.Point.Forecast = open.Point.Forecast
  .SD[, .(.N, open.mape = MLmetrics::MAPE(y_true = open, open.Point.Forecast), 
          open.smape = Metrics::smape(actual = open, predicted = open.Point.Forecast), 
          open.mse = MLmetrics::MSE(y_true = open, open.Point.Forecast), 
          open.rmse = MLmetrics::RMSE(y_true = open, open.Point.Forecast)), 
      by=.(Model, Period)]}][order(Model, Period), ]

m.hi <- seasonal_m1[, {
  high = high
  high.Point.Forecast = high.Point.Forecast
  .SD[, .(.N, high.mape = MLmetrics::MAPE(y_true = high, high.Point.Forecast), 
          high.smape = Metrics::smape(actual = high, predicted = high.Point.Forecast), 
          high.mse = MLmetrics::MSE(y_true = high, high.Point.Forecast), 
          high.rmse = MLmetrics::RMSE(y_true = high, y_pred = high.Point.Forecast)), 
      by=.(Model, Period)]}][order(Model, Period), ]

m.lo <- seasonal_m1[, {
  low = low
  low.Point.Forecast = low.Point.Forecast
  .SD[, .(.N, low.mape = MLmetrics::MAPE(y_true = low, low.Point.Forecast), 
          low.smape = Metrics::smape(actual = low, predicted = low.Point.Forecast), 
          low.mse = MLmetrics::MSE(y_true = low, low.Point.Forecast), 
          low.rmse = MLmetrics::RMSE(y_true = low, low.Point.Forecast)), 
      by=.(Model, Period)]}][order(Model, Period), ]

m.cl <- seasonal_m1[, {
  close = close
  close.Point.Forecast = close.Point.Forecast
  .SD[, .(.N, close.mape = MLmetrics::MAPE(y_true = close, close.Point.Forecast), 
          close.smape = Metrics::smape(actual = close, predicted = close.Point.Forecast), 
          close.mse = MLmetrics::MSE(y_true = close, close.Point.Forecast), 
          close.rmse = MLmetrics::RMSE(y_true = close, y_pred = close.Point.Forecast)), 
      by=.(Model, Period)]}][order(Model, Period), ]

best_model <- join_all(list(m.op, m.hi, m.lo, m.cl)) %>% tibble
saveRDS(best_model, 'data/fx/USDJPY/best_m_daily.rds')
rm(m.op, m.hi, m.lo, m.cl)
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
best_model <- readRDS('data/fx/USDJPY/best_m_daily.rds')

tb12 <- best_model %>% 
  dplyr::mutate(
    open.mape = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.smape = ifelse(
      rank(open.smape) <= 3, 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mse = ifelse(
      rank(open.mse) <= 3, 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.rmse = ifelse(
      rank(open.rmse) <= 3, 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    high.mape = ifelse(
      rank(high.mape) <= 3, 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.smape = ifelse(
      rank(high.smape) <= 3, 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.mse = ifelse(
      rank(high.mse) <= 3, 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.rmse = ifelse(
      rank(high.rmse) <= 3, 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    low.mape = ifelse(
      rank(low.mape) <= 3, 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.smape = ifelse(
      rank(low.smape) <= 3, 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.mse = ifelse(
      rank(low.mse) <= 3, 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.rmse = ifelse(
      rank(low.rmse) <= 3, 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    close.mape = ifelse(
      rank(close.mape) <= 3, 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.smape = ifelse(
      rank(close.smape) <= 3, 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.mse = ifelse(
      rank(close.mse) <= 3, 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.rmse = ifelse(
      rank(close.rmse) <= 3, 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>%   
  column_spec(7, background = 'Gainsboro') %>% 
  column_spec(8, background = 'LightGray') %>% 
  column_spec(9, background = 'Gainsboro') %>% 
  column_spec(10, background = 'LightGray') %>%   
  column_spec(11, background = 'Gainsboro') %>% 
  column_spec(12, background = 'LightGray') %>% 
  column_spec(13, background = 'Gainsboro') %>% 
  column_spec(14, background = 'LightGray') %>%   
  column_spec(15, background = 'Gainsboro') %>% 
  column_spec(16, background = 'LightGray') %>% 
  column_spec(17, background = 'Gainsboro') %>% 
  column_spec(18, background = 'LightGray') %>%   
  column_spec(19, background = 'Gainsboro') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb12
```

```{r include = FALSE}
rm(tb12)
```

Above table summarized the total observations with `mape`, `smape`, `mse` and `rmse` values (which is not nested summarize <span style='color:red'>not daily settlement for P&L</span>), we can interpret from above table :

- Weekly or `7200 mins` length's dataset with `msts(seasonal.periods = c(1440, 7200)) %>% tbats %>% forecast(h = 1440)`.
- Quarterly length's dataset with `tk_ts(frequency = 1440) %>% forecast(h=1440)`.
- Annum length's dataset with `tk_ts(frequency = 1440) %>% forecast(h=1440)`.

#### Sarima

```{r, warning = FALSE, message = FALSE, results = 'asis'}
##Below model use open price dataset where contain 7200 mins and forecast 1440 mins.
fit_ts <- readRDS('data/fx/USDJPY/sarima_ts_sample.rds')
#fr_ts <- forecast(fit_ts, h = 1440)
fr_ts <- readRDS('data/fx/USDJPY/sarima_frts_sample.rds')
fr_ts.sample <- readRDS('data/fx/USDJPY/fr_ts.sample.wk.1440.2015-01-12.rds')

##Below model use open price dataset where contain 7200 mins and forecast nested 60mins & 1440 mins.
fit_msts <- readRDS('data/fx/USDJPY/sarima_msts_sample.rds')
fr_msts <- readRDS('data/fx/USDJPY/sarima_frmsts_sample.rds')
fr_msts.sample <- readRDS('data/fx/USDJPY/fr_msts.sample.wk.1440.2015-01-12.rds')
```

Due to heavily calculation on sarima models, here I only use 1st week `r paste('from', range(fr_ts.sample$index), collapse = ' to ')`` calculate.

```{r, warning = FALSE, message = FALSE, results = 'asis'}
cmp1 <- join(fr_ts.sample, fr_msts.sample) %>% 
  as_tibble %>% na.omit

lst1 <- list.files('data/fx/USDJPY', pattern = '^mts.*.2015-01-12.rds$')
cmp2 <- llply(lst1, function(x) {
    readRDS(paste0('data/fx/USDJPY/', x)) %>% 
    dplyr::select(contains(c('index', 'open.Point.Forecast'))) %>% 
    .[,1:2]
  })
names(cmp2) <- str_replace_all(lst1, '.[1-9].*', '')
cmp2 %<>% ldply %>% 
  as_tibble %>% 
  spread(.id, open.Point.Forecast)
cmp2 <- data.frame(open = cmp1$open, cmp2) %>% 
  as_tibble %>% 
  .[c(2:1, 3:ncol(.))]

lst2 <- list.files('data/fx/USDJPY', pattern = '^sets.*.2015-01-12.rds$')
cmp3 <- llply(lst2, function(x) {
    readRDS(paste0('data/fx/USDJPY/', x))$forecast %>% 
    dplyr::select(contains(c('index', 'open.Point.Forecast'))) %>% 
    .[1:1440,1:2]
  })
names(cmp3) <- substr(lst2, 1, 12) #manual filter characters
cmp3 %<>% ldply %>% 
  as_tibble %>% 
  spread(.id, open.Point.Forecast)
cmp3 <- data.frame(open = cmp1$open, cmp3) %>% 
  as_tibble %>% 
  .[c(2:1, 3:ncol(.))]

## ------------------------
cmp1 <- data.frame(
  Model = c('sarima_ts', 'sarima_msts'), 
  n = nrow(cmp1), 
  mae = c(MAE(cmp1$open, cmp1$sarima_ts, na.rm = TRUE), 
           MAE(cmp1$open, cmp1$sarima_msts, na.rm = TRUE)), 
  mape = c(MAPE(cmp1$open, cmp1$sarima_ts, na.rm = TRUE), 
           MAPE(cmp1$open, cmp1$sarima_msts, na.rm = TRUE)), 
  smape = c(Metrics::smape(actual = cmp1$open, predicted = cmp1$sarima_ts, na.rm = TRUE), 
            Metrics::smape(actual = cmp1$open, predicted = cmp1$sarima_msts, na.rm = TRUE)), 
  mse = c(MSE(cmp1$open, cmp1$sarima_ts, na.rm = TRUE), 
          MSE(cmp1$open, cmp1$sarima_msts, na.rm = TRUE)), 
  rmse = c(MLmetrics::RMSE(y_true = cmp1$open, y_pred = cmp1$sarima_ts, na.rm = TRUE), 
           MLmetrics::RMSE(y_true = cmp1$open, y_pred = cmp1$sarima_msts, na.rm = TRUE))) %>% 
  as_tibble

cmp2 <- data.frame(
  Model = names(cmp2[3:ncol(cmp2)]), 
  n = nrow(cmp2), 
  mae = c(MAE(cmp2$open, cmp2$mts.dy.qt, na.rm = TRUE), 
          MAE(cmp2$open, cmp2$mts.dy.wk, na.rm = TRUE), 
          MAE(cmp2$open, cmp2$mts.dy.wk.mo, na.rm = TRUE), 
          MAE(cmp2$open, cmp2$mts.dy.yr, na.rm = TRUE)), 
  mape = c(MAPE(cmp2$open, cmp2$mts.dy.qt, na.rm = TRUE), 
           MAPE(cmp2$open, cmp2$mts.dy.wk, na.rm = TRUE), 
           MAPE(cmp2$open, cmp2$mts.dy.wk.mo, na.rm = TRUE), 
           MAPE(cmp2$open, cmp2$mts.dy.yr, na.rm = TRUE)), 
  smape = c(Metrics::smape(cmp2$open, cmp2$mts.dy.qt, na.rm = TRUE), 
            Metrics::smape(cmp2$open, cmp2$mts.dy.wk, na.rm = TRUE), 
            Metrics::smape(cmp2$open, cmp2$mts.dy.wk.mo, na.rm = TRUE), 
            Metrics::smape(cmp2$open, cmp2$mts.dy.yr, na.rm = TRUE)), 
  mse = c(MSE(cmp2$open, cmp2$mts.dy.qt, na.rm = TRUE), 
          MSE(cmp2$open, cmp2$mts.dy.wk, na.rm = TRUE), 
          MSE(cmp2$open, cmp2$mts.dy.wk.mo, na.rm = TRUE), 
          MSE(cmp2$open, cmp2$mts.dy.yr, na.rm = TRUE)), 
  rmse = c(MLmetrics::RMSE(y_true = cmp2$open, y_pred = cmp2$mts.dy.qt, na.rm = TRUE), 
           MLmetrics::RMSE(y_true = cmp2$open, y_pred = cmp2$mts.dy.wk, na.rm = TRUE), 
           MLmetrics::RMSE(y_true = cmp2$open, y_pred = cmp2$mts.dy.wk.mo, na.rm = TRUE), 
           MLmetrics::RMSE(y_true = cmp2$open, y_pred = cmp2$mts.dy.yr, na.rm = TRUE))) %>% 
  as_tibble

cmp3 <- data.frame(
  Model = names(cmp3)[3:ncol(cmp3)], 
  n = nrow(cmp3), 
  mae = c(MAE(cmp3$open, cmp3$sets.mo.1440, na.rm = TRUE), 
          MAE(cmp3$open, cmp3$sets.mo.7200, na.rm = TRUE), 
          MAE(cmp3$open, cmp3$sets.qt.1440, na.rm = TRUE), 
          MAE(cmp3$open, cmp3$sets.qt.7200, na.rm = TRUE), 
          MAE(cmp3$open, cmp3$sets.wk.1440, na.rm = TRUE), 
          MAE(cmp3$open, cmp3$sets.wk.7200, na.rm = TRUE), 
          MAE(cmp3$open, cmp3$sets.yr.1440, na.rm = TRUE), 
          MAE(cmp3$open, cmp3$sets.yr.7200, na.rm = TRUE)), 
  mape = c(MAPE(cmp3$open, cmp3$sets.mo.1440, na.rm = TRUE), 
           MAPE(cmp3$open, cmp3$sets.mo.7200, na.rm = TRUE), 
           MAPE(cmp3$open, cmp3$sets.qt.1440, na.rm = TRUE), 
           MAPE(cmp3$open, cmp3$sets.qt.7200, na.rm = TRUE), 
           MAPE(cmp3$open, cmp3$sets.wk.1440, na.rm = TRUE), 
           MAPE(cmp3$open, cmp3$sets.wk.7200, na.rm = TRUE), 
           MAPE(cmp3$open, cmp3$sets.yr.1440, na.rm = TRUE), 
           MAPE(cmp3$open, cmp3$sets.yr.7200, na.rm = TRUE)), 
  smape = c(Metrics::smape(actual = cmp3$open, predicted = cmp3$sets.mo.1440, na.rm = TRUE), 
            Metrics::smape(actual = cmp3$open, predicted = cmp3$sets.mo.7200, na.rm = TRUE), 
            Metrics::smape(actual = cmp3$open, predicted = cmp3$sets.qt.1440, na.rm = TRUE), 
            Metrics::smape(actual = cmp3$open, predicted = cmp3$sets.qt.7200, na.rm = TRUE), 
            Metrics::smape(actual = cmp3$open, predicted = cmp3$sets.wk.1440, na.rm = TRUE), 
            Metrics::smape(actual = cmp3$open, predicted = cmp3$sets.wk.7200, na.rm = TRUE), 
            Metrics::smape(actual = cmp3$open, predicted = cmp3$sets.yr.1440, na.rm = TRUE), 
            Metrics::smape(actual = cmp3$open, predicted = cmp3$sets.yr.7200, na.rm = TRUE)), 
  mse = c(MSE(cmp3$open, cmp3$sets.mo.1440, na.rm = TRUE), 
          MSE(cmp3$open, cmp3$sets.mo.7200, na.rm = TRUE), 
          MSE(cmp3$open, cmp3$sets.qt.1440, na.rm = TRUE), 
          MSE(cmp3$open, cmp3$sets.qt.7200, na.rm = TRUE), 
          MSE(cmp3$open, cmp3$sets.wk.1440, na.rm = TRUE), 
          MSE(cmp3$open, cmp3$sets.wk.7200, na.rm = TRUE), 
          MSE(cmp3$open, cmp3$sets.yr.1440, na.rm = TRUE), 
          MSE(cmp3$open, cmp3$sets.yr.7200, na.rm = TRUE)), 
  rmse = c(MLmetrics::RMSE(y_true = cmp3$open, y_pred = cmp3$sets.mo.1440, na.rm = TRUE), 
           MLmetrics::RMSE(y_true = cmp3$open, y_pred = cmp3$sets.mo.7200, na.rm = TRUE), 
           MLmetrics::RMSE(y_true = cmp3$open, y_pred = cmp3$sets.qt.1440, na.rm = TRUE), 
           MLmetrics::RMSE(y_true = cmp3$open, y_pred = cmp3$sets.qt.7200, na.rm = TRUE), 
           MLmetrics::RMSE(y_true = cmp3$open, y_pred = cmp3$sets.wk.1440, na.rm = TRUE), 
           MLmetrics::RMSE(y_true = cmp3$open, y_pred = cmp3$sets.wk.7200, na.rm = TRUE), 
           MLmetrics::RMSE(y_true = cmp3$open, y_pred = cmp3$sets.yr.1440, na.rm = TRUE), 
           MLmetrics::RMSE(y_true = cmp3$open, y_pred = cmp3$sets.yr.7200, na.rm = TRUE))) %>% 
  as_tibble

cmp <- bind_rows(cmp1, cmp2, cmp3) %>% 
  as_tibble
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb13 <- cmp %>% 
  dplyr::mutate(
    mae = ifelse(
      rank(mae) <= 3, 
      cell_spec(
        paste0(round(mae, 7), ' (rank: ', sprintf('%1.f', rank(mae)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(mae, 7), ' (rank: ', sprintf('%1.f', rank(mae)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    mape = ifelse(
      rank(mape) <= 3, 
      cell_spec(
        paste0(round(mape, 7), ' (rank: ', sprintf('%1.f', rank(mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(mape, 7), ' (rank: ', sprintf('%1.f', rank(mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    smape = ifelse(
      rank(smape) <= 3, 
      cell_spec(
        paste0(round(smape, 7), ' (rank: ', sprintf('%1.f', rank(smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(smape, 7), ' (rank: ', sprintf('%1.f', rank(smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    mse = ifelse(
      rank(mse) <= 3, 
      cell_spec(
        paste0(round(mse, 7), ' (rank: ', sprintf('%1.f', rank(mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(mse, 7), ' (rank: ', sprintf('%1.f', rank(mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    rmse = ifelse(
      rank(rmse) <= 3, 
      cell_spec(
        paste0(round(rmse, 7), ' (rank: ', sprintf('%1.f', rank(rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(rmse, 7), ' (rank: ', sprintf('%1.f', rank(rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Sarima_ts & Sarima_msts Models etc', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  #column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(3, background = 'LightGray') %>% 
  column_spec(4, background = 'Gainsboro') %>% 
  column_spec(5, background = 'LightGray') %>% 
  column_spec(6, background = 'Gainsboro') %>% 
  column_spec(7, background = 'LightGray') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb13
```

```{r include = FALSE}
rm(cmp, tb13)
```

[Application of `auto.arima()` on both `ts()` and `msts()` seasonal datasets](https://stackoverflow.com/questions/65699784/application-of-auto-arima-on-both-ts-and-msts-seasonal-dataset) compare the `ts()` and `msts()` sarima models.

## 1 day per unit

### Interday `ETS` Model

Below I recall the `ETS` models for interday price prediction in previous paper for comparison.

```{r, warning = FALSE, message = FALSE, results = 'asis'}
ets.fls <- list.files('data', pattern = '^[A-Z]{3}\\.[A-Za-z]{4}')
ETS.MSE <- llply(ets.fls, function(x) {
    nm <- x %>% 
      str_replace_all('.rds', '') %>% 
      str_split_fixed('\\.', 2) %>% 
      as_data_frame
    names(nm) <- c('Model', 'Type')
    
    y <- paste0('data/', x) %>% 
      read_rds
    
    data.frame(nm, y) %>% as_tibble
  }) %>% bind_rows %>% 
  dplyr::select(Date, Model,Type, Point.Forecast, forClose, 
                USDJPY.Open, USDJPY.High, USDJPY.Low, USDJPY.Close)

ETS.MSE %<>% dplyr::mutate(
    MSE.1 = case_when(
        substr(Type, 1, 2) == 'Op' ~ mean((Point.Forecast - USDJPY.Open)^2, 
                                          na.rm = TRUE), 
        substr(Type, 1, 2) == 'Hi' ~ mean((Point.Forecast - USDJPY.High)^2, 
                                          na.rm = TRUE), 
        substr(Type, 1, 2) == 'Mn' ~ mean((Point.Forecast - (USDJPY.High + USDJPY.Low)/2)^2, na.rm = TRUE), 
        substr(Type, 1, 2) == 'Lo' ~ mean((Point.Forecast - USDJPY.Low)^2, 
                                          na.rm = TRUE), 
        substr(Type, 1, 2) == 'Cl' ~ mean((Point.Forecast - USDJPY.Close)^2, 
                                          na.rm = TRUE)), 
    MSE.2 = case_when(
        substr(Type, 3, 4) == 'Op' ~ mean((Point.Forecast - USDJPY.Open)^2, 
                                          na.rm = TRUE), 
        substr(Type, 3, 4) == 'Hi' ~ mean((Point.Forecast - USDJPY.High)^2, 
                                          na.rm = TRUE), 
        substr(Type, 3, 4) == 'Mn' ~ mean((Point.Forecast - (USDJPY.High + USDJPY.Low)/2)^2, na.rm = TRUE), 
        substr(Type, 3, 4) == 'Lo' ~ mean((Point.Forecast - USDJPY.Low)^2, 
                                          na.rm = TRUE), 
        substr(Type, 3, 4) == 'Cl' ~ mean((Point.Forecast - USDJPY.Close)^2, 
                                          na.rm = TRUE)))

ETS.MSE %<>% 
    ddply(.(Model, Type), summarise, 
          MSE.1 = mean(MSE.1, na.rm=TRUE), 
          MSE.2 = mean(MSE.2, na.rm=TRUE))

tb14 <- ETS.MSE %>% dplyr::mutate(
    MSE.1 = ifelse(
      rank(MSE.1) <= 3, 
      cell_spec(
        paste0(round(MSE.1, 7), ' (rank: ', sprintf('%1.f', rank(MSE.1)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(MSE.1, 7), ' (rank: ', sprintf('%1.f', rank(MSE.1)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    MSE.2 = ifelse(
      rank(MSE.2) <= 3, 
      cell_spec(
        paste0(round(MSE.2, 7), ' (rank: ', sprintf('%1.f', rank(MSE.2)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(MSE.2, 7), ' (rank: ', sprintf('%1.f', rank(MSE.2)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'MSE of daily Opened and Closed Transaction Orders', escape = FALSE) %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kableExtra::group_rows('AAN', 1, 25, label_row_css = 'background-color: #e68a00; color: #fff;') %>%
  kableExtra::group_rows('AAZ', 26, 50, label_row_css = 'background-color: #ff0000; color: #fff;') %>%
  kableExtra::group_rows('ANN', 51, 75, label_row_css = 'background-color: #bf80ff; color: #fff;') %>%
  kableExtra::group_rows('ANZ', 76, 100, label_row_css = 'background-color: #66ff33; color: #fff;') %>%
  kableExtra::group_rows('AZN', 101, 125, label_row_css = 'background-color: #6666ff; color: #fff;') %>%
  kableExtra::group_rows('AZZ', 126, 150, label_row_css = 'background-color: #66e0ff; color: #fff;') %>%
  kableExtra::group_rows('MAN', 151, 175, label_row_css = 'background-color:#0066ff; color: #fff;') %>%
  kableExtra::group_rows('MAZ', 176, 200, label_row_css = 'background-color: #ff9900; color: #fff;') %>%
  kableExtra::group_rows('MMN', 201, 225, label_row_css = 'background-color: #33ff33; color: #fff;') %>%
  kableExtra::group_rows('MMZ', 226, 250, label_row_css = 'background-color: #339966; color: #fff;') %>%
  kableExtra::group_rows('MNN', 251, 275, label_row_css = 'background-color: #5900b3; color: #fff;') %>%
  kableExtra::group_rows('MNZ', 276, 300, label_row_css = 'background-color: #269900; color: #fff;') %>%
  kableExtra::group_rows('MZN', 301, 325, label_row_css = 'background-color: #808000; color: #fff;') %>%
  kableExtra::group_rows('MZZ', 326, 350, label_row_css = 'background-color: #3399ff; color: #fff;') %>%
  kableExtra::group_rows('ZAN', 351, 375, label_row_css = 'background-color: #003380; color: #fff;') %>%
  kableExtra::group_rows('ZAZ', 376, 400, label_row_css = 'background-color: #804d00; color: #fff;') %>%
  kableExtra::group_rows('ZMN', 401, 425, label_row_css = 'background-color: #d279d2; color: #fff;') %>%
  kableExtra::group_rows('ZMZ', 426, 450, label_row_css = 'background-color: #666; color: #fff;') %>%
  kableExtra::group_rows('ZNN', 451, 475, label_row_css = 'background-color: #ff3377; color: #fff;') %>%
  kableExtra::group_rows('ZNZ', 476, 500, label_row_css = 'background-color: #993399; color: #fff;') %>%
  kableExtra::group_rows('ZZN', 501, 525, label_row_css = 'background-color: #00a3cc; color: #fff;') %>%
  kableExtra::group_rows('ZZZ', 526, 550, label_row_css = 'background-color: #e60000; color: #fff;') %>%
  scroll_box(width = '100%', fixed_thead = TRUE, height = '400px')

tb14
```

```{r include = FALSE}
rm(tb14)
```

*Source : [Binary.com Interview Q1 (Extention)](http://rpubs.com/englianhu/binary-Q1E)*

From above `MSE` comparison with intraday-dataset, we know that the intraday data will be more accurate than just daily dataset.

### Interday `auto.arima` Model

- [Forecasting: Principles and Practice - *11.1 Complex seasonality*](https://otexts.com/fpp2/complexseasonality.html#complexseasonality)
- [Forecasting: Principles and Practice - *12.1 Weekly, daily and sub-daily data*](https://otexts.com/fpp2/weekly.html#weekly)

```{r, warning = FALSE, message = FALSE, results = 'asis'}
ar.fls <- list.files('data', pattern = '^fundAutoArima')
ARIMA.MSE <- llply(ar.fls, function(x) {
    nm <- x %>% 
      str_replace_all('.rds', '') %>% 
      substring(nchar(.) - 3)
    
    y <- paste0('data/', x) %>% 
      read_rds
    
    data.frame(Model = 'auto.arima', Type = nm, y) %>% as_tibble
  }) %>% bind_rows %>% 
  dplyr::mutate(index = Date) %>% 
  dplyr::select(index, Model, Type, Point.Forecast, forClose, 
                USDJPY.Open, USDJPY.High, USDJPY.Low, USDJPY.Close, 
                -Date)

ARIMA.MSE %<>% dplyr::mutate(
  MSE.1 = case_when(
    substr(Type, 1, 2) == 'OP' ~ mean((Point.Forecast - USDJPY.Open)^2), 
    substr(Type, 1, 2) == 'HI' ~ mean((Point.Forecast - USDJPY.High)^2), 
    substr(Type, 1, 2) == 'MN' ~ mean((Point.Forecast - (USDJPY.High + USDJPY.Low)/2)^2), 
    substr(Type, 1, 2) == 'LO' ~ mean((Point.Forecast - USDJPY.Low)^2), 
    substr(Type, 1, 2) == 'CL' ~ mean((Point.Forecast - USDJPY.Close)^2)), 
  MSE.2 = case_when(
    substr(Type, 3, 4) == 'OP' ~ mean((Point.Forecast - USDJPY.Open)^2), 
    substr(Type, 3, 4) == 'HI' ~ mean((Point.Forecast - USDJPY.High)^2), 
    substr(Type, 3, 4) == 'MN' ~ mean((Point.Forecast - (USDJPY.High + USDJPY.Low)/2)^2), 
    substr(Type, 3, 4) == 'LO' ~ mean((Point.Forecast - USDJPY.Low)^2), 
    substr(Type, 3, 4) == 'CL' ~ mean((Point.Forecast - USDJPY.Close)^2)))

tb15 <- ARIMA.MSE %>% 
    ddply(.(Model), summarise, 
          MSE.1 = mean(MSE.1, na.rm=TRUE), 
          MSE.2 = mean(MSE.2, na.rm=TRUE)) %>% 
  arrange(MSE.1, MSE.2) %>% 
  kable(caption = 'MSE of daily Opened and Closed Transaction Orders') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive'))

tb15
```

```{r include = FALSE}
rm(tb15)
```

By refer to section [7.1.3 Unexpected abnor](https://rpubs.com/englianhu/binary-Q1Inter-HFT.html#713_Unexpected_abnor), here I omitted the data from year `2018-01-01` to `2018-07-09` but the outcome is same. Here I forced to omit the mentioned dataset.

## Filtered Dataset From `2015-01-05` to `2017-12-31`

### Unfilter `7200` mins Dataset

#### Overview

```{r, eval = FALSE, warning = FALSE, message = FALSE, results = 'asis'}
if(!exists('seasonal_m1')) {
  seasonal_m1 <- read_rds('data/fx/USDJPY/seasonal_m1.rds')}

## https://dtplyr.tidyverse.org for future use, otherwise need to recode and rerun.
#ftl1 <- seasonal_m1 %>% lazy_dt()
#ftl1 %<>% filter(index <= as_date('2017-12-31'))
#ftl1 %<>% as.data.table()
ftl1 <- seasonal_m1[index <= as_date('2017-12-31')]
#setkey(ftl1)
#setkeyv(ftl1, c('index', 'Model', 'Period'))
```

```{r, eval = FALSE, warning = FALSE, message = FALSE, results = 'asis'}
yr_2015_2017 <- seasonal_m1[index <= as_date('2017-12-31')]
saveRDS(yr_2015_2017, 'data/fx/USDJPY/yr_2015_2017.rds')
#fwrite(yr_2015_2017, 'data/fx/USDJPY/yr_2015_2017.csv')
```

```{r, include = FALSE}
rm(seaonal_m1)
gc()
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
#yr_2015_2017 <- read_rds('data/fx/USDJPY/yr_2015_2017.rds')
#ftl1 <- fread('data/fx/USDJPY/yr_2015_2017.csv')
ftl1 <- read_rds('data/fx/USDJPY/yr_2015_2017.rds')

m.op <- ftl1[, {
    open = open
    open.Point.Forecast = open.Point.Forecast
    .SD[, .(.N, 
            open.mae = MAE(open, open.Point.Forecast), 
            open.mape = MLmetrics::MAPE(y_true = open, open.Point.Forecast), 
            open.smape = Metrics::smape(actual = open, predicted = open.Point.Forecast), 
            open.mse = MLmetrics::MSE(y_true = open, open.Point.Forecast), 
            open.rmse = MLmetrics::RMSE(y_true = open, y_pred = open.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

m.hi <- ftl1[, {
    high = high
    high.Point.Forecast = high.Point.Forecast
    .SD[, .(.N, 
            high.mae = MAE(high, high.Point.Forecast), 
            high.mape = MLmetrics::MAPE(y_true = high, high.Point.Forecast), 
            high.smape = Metrics::smape(actual = high, predicted = high.Point.Forecast), 
            high.mse = MLmetrics::MSE(y_true = high, high.Point.Forecast), 
            high.rmse = MLmetrics::RMSE(y_true = high, high.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

m.lo <- ftl1[, {
    low = low
    low.Point.Forecast = low.Point.Forecast
    .SD[, .(.N, 
            low.mae = MAE(low, low.Point.Forecast), 
            low.mape = MLmetrics::MAPE(y_true = low, low.Point.Forecast), 
            low.smape = Metrics::smape(actual = low, predicted = low.Point.Forecast), 
            low.mse = MLmetrics::MSE(y_true = low, low.Point.Forecast), 
            low.rmse = MLmetrics::RMSE(y_true = low, y_pred = low.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

m.cl <- ftl1[, {
    close = close
    close.Point.Forecast = close.Point.Forecast
    .SD[, .(.N, 
            close.mae = MAE(close, close.Point.Forecast), 
            close.mape = MLmetrics::MAPE(y_true = close, close.Point.Forecast), 
            close.smape = Metrics::smape(actual = close, predicted = close.Point.Forecast), 
            close.mse = MLmetrics::MSE(y_true = close, close.Point.Forecast), 
            close.rmse = MLmetrics::RMSE(y_true = close, y_pred = close.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

ftl_dat1a <- join_all(list(m.op, m.hi, m.lo, m.cl)) %>% 
  as_tibble
```

The models `r paste(unique(ftl1$Period)[str_detect(unique(ftl1$Period), '7200')], collapse = ', ')` predict `7200` mins data in advanced per day. But models `r paste(unique(ftl1$Period)[str_detect(unique(ftl1$Period), '1440')], collapse = ', ')` only predict `1440` mins data in advanced per day. Therefore there will be different data size and duplicate forecasted price.

#### Overall Dataset

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb16 <- ftl_dat1a %>% 
  dplyr::mutate(
    open.mae = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mape = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.smape = ifelse(
      rank(open.smape) <= 3, 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mse = ifelse(
      rank(open.mse) <= 3, 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.rmse = ifelse(
      rank(open.rmse) <= 3, 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    high.mape = ifelse(
      rank(high.mape) <= 3, 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.smape = ifelse(
      rank(high.smape) <= 3, 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.mse = ifelse(
      rank(high.mse) <= 3, 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.rmse = ifelse(
      rank(high.rmse) <= 3, 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    low.mape = ifelse(
      rank(low.mape) <= 3, 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.smape = ifelse(
      rank(low.smape) <= 3, 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.mse = ifelse(
      rank(low.mse) <= 3, 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.rmse = ifelse(
      rank(low.rmse) <= 3, 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    close.mape = ifelse(
      rank(close.mape) <= 3, 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.smape = ifelse(
      rank(close.smape) <= 3, 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.mse = ifelse(
      rank(close.mse) <= 3, 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.rmse = ifelse(
      rank(close.rmse) <= 3, 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min summarised to 1 day per unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>%   
  column_spec(7, background = 'Gainsboro') %>% 
  column_spec(8, background = 'LightGray') %>% 
  column_spec(9, background = 'Gainsboro') %>% 
  column_spec(10, background = 'LightGray') %>%   
  column_spec(11, background = 'Gainsboro') %>% 
  column_spec(12, background = 'LightGray') %>% 
  column_spec(13, background = 'Gainsboro') %>% 
  column_spec(14, background = 'LightGray') %>%   
  column_spec(15, background = 'Gainsboro') %>% 
  column_spec(16, background = 'LightGray') %>% 
  column_spec(17, background = 'Gainsboro') %>% 
  column_spec(18, background = 'LightGray') %>% 
  column_spec(19, background = 'Gainsboro') %>% 
  column_spec(20, background = 'LightGray') %>% 
  column_spec(21, background = 'Gainsboro') %>% 
  column_spec(22, background = 'LightGray') %>% 
  column_spec(23, background = 'Gainsboro') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb16
```

```{r include = FALSE}
rm(tb16)
```

Above table summarized the total observations with `mape`, `smape`, `mse` and `rmse` values (which is not nested summarize <span style='color:red'>not daily settlement for P&L</span>).

#### Daily Dataset

```{r, warning = FALSE, message = FALSE, results = 'asis'}
open.accr <- ftl1[, {
  open = open
  open.Point.Forecast = open.Point.Forecast
  .SD[, .(.N, 
          open.mae = MAE(open, open.Point.Forecast), 
          open.mape = MLmetrics::MAPE(y_true = open, open.Point.Forecast), 
          open.smape = Metrics::smape(actual = open, predicted = open.Point.Forecast), 
          open.mse = MLmetrics::MSE(y_true = open, open.Point.Forecast), 
          open.rmse = MLmetrics::RMSE(y_true = open, y_pred = open.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

high.accr <- ftl1[, {
  high = high
  high.Point.Forecast = high.Point.Forecast
  .SD[, .(.N, 
          high.mae = MAE(high, high.Point.Forecast), 
          high.mape = MLmetrics::MAPE(y_true = high, high.Point.Forecast), 
          high.smape = Metrics::smape(actual = high, predicted = high.Point.Forecast), 
          high.mse = MLmetrics::MSE(y_true = high, high.Point.Forecast), 
          high.rmse = MLmetrics::RMSE(y_true = high, y_pred = high.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

low.accr <- ftl1[, {
  low = low
  low.Point.Forecast = low.Point.Forecast
  .SD[, .(.N, 
          low.mae = MAE(low, low.Point.Forecast), 
          low.mape = MLmetrics::MAPE(y_true = low, low.Point.Forecast), 
          low.smape = Metrics::smape(actual = low, predicted = low.Point.Forecast), 
          low.mse = MLmetrics::MSE(y_true = low, low.Point.Forecast), 
          low.rmse = MLmetrics::RMSE(y_true = low, y_pred = low.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

close.accr <- ftl1[, {
  close = close
  close.Point.Forecast = close.Point.Forecast
  .SD[, .(.N, 
          close.mae = MAE(close, close.Point.Forecast), 
          close.mape = MLmetrics::MAPE(y_true = close, close.Point.Forecast), 
          close.smape = Metrics::smape(actual = close, predicted = close.Point.Forecast), 
          close.mse = MLmetrics::MSE(y_true = close, close.Point.Forecast), 
          close.rmse = MLmetrics::RMSE(y_true = close, y_pred = close.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

open.sm <- open.accr[, list(
  N = mean(N), 
  open.mae = mean(open.mae), 
  open.mape = mean(open.mape), 
  open.smape = mean(open.smape), 
  open.mse = mean(open.mse), 
  open.rmse = mean(open.rmse)), 
  by=.(Model, Period)]

high.sm <- high.accr[, list(
  N = mean(N), 
  high.mae = mean(high.mae), 
  high.mape = mean(high.mape), 
  high.smape = mean(high.smape), 
  high.mse = mean(high.mse), 
  high.rmse = mean(high.rmse)), 
  by=.(Model, Period)]

low.sm <- low.accr[, list(
  N = mean(N), 
  low.mae = mean(low.mae), 
  low.mape = mean(low.mape), 
  low.smape = mean(low.smape), 
  low.mse = mean(low.mse), 
  low.rmse = mean(low.rmse)), 
  by=.(Model, Period)]

close.sm <- close.accr[, list(
  N = mean(N), 
  close.mae = mean(close.mae), 
  close.mape = mean(close.mape), 
  close.smape = mean(close.smape), 
  close.mse = mean(close.mse), 
  close.rmse = mean(close.rmse)), 
  by=.(Model, Period)]

ftl_dat1b <- join_all(list(open.sm, high.sm, low.sm, close.sm)) %>% 
  as_tibble
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb17 <- ftl_dat1b %>% 
  dplyr::mutate(
    open.mae = ifelse(
      rank(open.mae) <= 3, 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mape = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.smape = ifelse(
      rank(open.smape) <= 3, 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mse = ifelse(
      rank(open.mse) <= 3, 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.rmse = ifelse(
      rank(open.rmse) <= 3, 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    high.mape = ifelse(
      rank(high.mape) <= 3, 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.smape = ifelse(
      rank(high.smape) <= 3, 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.mse = ifelse(
      rank(high.mse) <= 3, 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.rmse = ifelse(
      rank(high.rmse) <= 3, 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    low.mape = ifelse(
      rank(low.mape) <= 3, 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.smape = ifelse(
      rank(low.smape) <= 3, 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.mse = ifelse(
      rank(low.mse) <= 3, 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.rmse = ifelse(
      rank(low.rmse) <= 3, 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    close.mape = ifelse(
      rank(close.mape) <= 3, 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.smape = ifelse(
      rank(close.smape) <= 3, 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.mse = ifelse(
      rank(close.mse) <= 3, 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.rmse = ifelse(
      rank(close.rmse) <= 3, 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min summarised to 1 day per unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  #column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>%   
  column_spec(7, background = 'Gainsboro') %>% 
  column_spec(8, background = 'LightGray') %>% 
  column_spec(9, background = 'Gainsboro') %>% 
  column_spec(10, background = 'LightGray') %>%   
  column_spec(11, background = 'Gainsboro') %>% 
  column_spec(12, background = 'LightGray') %>% 
  column_spec(13, background = 'Gainsboro') %>% 
  column_spec(14, background = 'LightGray') %>%   
  column_spec(15, background = 'Gainsboro') %>% 
  column_spec(16, background = 'LightGray') %>% 
  column_spec(17, background = 'Gainsboro') %>% 
  column_spec(18, background = 'LightGray') %>%   
  column_spec(19, background = 'Gainsboro') %>% 
  column_spec(20, background = 'LightGray') %>%  
  column_spec(21, background = 'Gainsboro') %>% 
  column_spec(22, background = 'LightGray') %>% 
  column_spec(23, background = 'Gainsboro') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb17
```

```{r include = FALSE}
rm(tb17)
```

Above table summarized the daily `mape`, `smape`, `mse` and `rmse` values and then summarized again the models (which is nested summarize <span style='color:red'>due to daily settlement for P&L</span>).

### Filtered `7200` mins `unique(x, fromLast = FALSE)` Dataset

#### Overview

```{r, warning = FALSE, message = FALSE, results = 'asis'}
ftl2 <- unique(ftl1, fromLast = FALSE, by = c('index', 'Period'))#[Period == 'mo.7200']#[11440:12900]#[order(index)]
#setkey(ftl2)
setkeyv(ftl2, c('index', 'Model', 'Period'))

m.op <- ftl2[, {
    open = open
    open.Point.Forecast = open.Point.Forecast
    .SD[, .(.N, 
            open.mae = MAE(open, open.Point.Forecast), 
            open.mape = MLmetrics::MAPE(y_true = open, open.Point.Forecast), 
            open.smape = Metrics::smape(actual = open, predicted = open.Point.Forecast), 
            open.mse = MLmetrics::MSE(y_true = open, open.Point.Forecast), 
            open.rmse = MLmetrics::RMSE(y_true = open, y_pred = open.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

m.hi <- ftl2[, {
    high = high
    high.Point.Forecast = high.Point.Forecast
    .SD[, .(.N, 
            high.mae = MAE(high, high.Point.Forecast), 
            high.mape = MLmetrics::MAPE(y_true = high, high.Point.Forecast), 
            high.smape = Metrics::smape(actual = high, predicted = high.Point.Forecast), 
            high.mse = MLmetrics::MSE(y_true = high, high.Point.Forecast), 
            high.rmse = MLmetrics::RMSE(y_true = high, y_pred = high.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

m.lo <- ftl2[, {
    low = low
    low.Point.Forecast = low.Point.Forecast
    .SD[, .(.N, 
            low.mae = MAE(low, low.Point.Forecast), 
            low.mape = MLmetrics::MAPE(y_true = low, low.Point.Forecast), 
            low.smape = Metrics::smape(actual = low, predicted = low.Point.Forecast), 
            low.mse = MLmetrics::MSE(y_true = low, low.Point.Forecast), 
            low.rmse = MLmetrics::RMSE(y_true = low, y_pred = low.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

m.cl <- ftl2[, {
    close = close
    close.Point.Forecast = close.Point.Forecast
    .SD[, .(.N, 
            close.mae = MAE(close, close.Point.Forecast), 
            close.mape = MLmetrics::MAPE(y_true = close, close.Point.Forecast), 
            close.smape = Metrics::smape(actual = close, predicted = close.Point.Forecast), 
            close.mse = MLmetrics::MSE(y_true = close, close.Point.Forecast), 
            close.rmse = MLmetrics::RMSE(y_true = close, y_pred = close.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

ftl_dat2a <- join_all(list(m.op, m.hi, m.lo, m.cl)) %>% 
  as_tibble
```

The models `r paste(unique(ftl2$Period)[str_detect(unique(ftl2$Period), '7200')], collapse = ', ')` predict `7200` mins data in advanced per day. But models `r paste(unique(ftl2$Period)[str_detect(unique(ftl2$Period), '1440')], collapse = ', ')` only predict `1440` mins data in advanced per day. Therefore there will be different data size and **duplicate forecasted price**.

Here I filtered to be unique forecasted price but `7200` mins in advanced per week. That means when I forecast data on `2015-01-17` for `2015-01-20` to `2015-01-25` which is `7200` mins in advanced. (All dataset will be forecast `7200` in advanced since I only filter and take **first row of every single min**)

#### Overall Dataset

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb18 <- ftl_dat2a %>% 
  dplyr::mutate(
    open.mae = ifelse(
      rank(open.mae) <= 3, 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mape = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.smape = ifelse(
      rank(open.smape) <= 3, 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mse = ifelse(
      rank(open.mse) <= 3, 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.rmse = ifelse(
      rank(open.rmse) <= 3, 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    high.mape = ifelse(
      rank(high.mape) <= 3, 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.smape = ifelse(
      rank(high.smape) <= 3, 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.mse = ifelse(
      rank(high.mse) <= 3, 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.rmse = ifelse(
      rank(high.rmse) <= 3, 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    low.mape = ifelse(
      rank(low.mape) <= 3, 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.smape = ifelse(
      rank(low.smape) <= 3, 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.mse = ifelse(
      rank(low.mse) <= 3, 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.rmse = ifelse(
      rank(low.rmse) <= 3, 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    close.mape = ifelse(
      rank(close.mape) <= 3, 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.smape = ifelse(
      rank(close.smape) <= 3, 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.mse = ifelse(
      rank(close.mse) <= 3, 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.rmse = ifelse(
      rank(close.rmse) <= 3, 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min summarised to 1 day per unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>%   
  column_spec(7, background = 'Gainsboro') %>% 
  column_spec(8, background = 'LightGray') %>% 
  column_spec(9, background = 'Gainsboro') %>% 
  column_spec(10, background = 'LightGray') %>%   
  column_spec(11, background = 'Gainsboro') %>% 
  column_spec(12, background = 'LightGray') %>% 
  column_spec(13, background = 'Gainsboro') %>% 
  column_spec(14, background = 'LightGray') %>%   
  column_spec(15, background = 'Gainsboro') %>% 
  column_spec(16, background = 'LightGray') %>% 
  column_spec(17, background = 'Gainsboro') %>% 
  column_spec(18, background = 'LightGray') %>% 
  column_spec(19, background = 'Gainsboro') %>% 
  column_spec(20, background = 'LightGray') %>%  
  column_spec(21, background = 'Gainsboro') %>% 
  column_spec(22, background = 'LightGray') %>% 
  column_spec(23, background = 'Gainsboro') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb18
```

```{r include = FALSE}
rm(tb18)
```

Above table summarized the total observations with `mape`, `smape`, `mse` and `rmse` values (which is not nested summarize <span style='color:red'>not daily settlement for P&L</span>).

#### Daily Dataset

```{r, warning = FALSE, message = FALSE, results = 'asis'}
open.accr <- ftl2[, {
  open = open
  open.Point.Forecast = open.Point.Forecast
  .SD[, .(.N, 
          open.mae = MAE(open, open.Point.Forecast), 
          open.mape = MLmetrics::MAPE(y_true = open, open.Point.Forecast), 
          open.smape = Metrics::smape(actual = open, predicted = open.Point.Forecast), 
          open.mse = MLmetrics::MSE(y_true = open, open.Point.Forecast), 
          open.rmse = MLmetrics::RMSE(y_true = open, y_pred = open.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

high.accr <- ftl2[, {
  high = high
  high.Point.Forecast = high.Point.Forecast
  .SD[, .(.N, 
          high.mae = MAE(high, high.Point.Forecast), 
          high.mape = MLmetrics::MAPE(y_true = high, high.Point.Forecast), 
          high.smape = Metrics::smape(actual = high, predicted = high.Point.Forecast), 
          high.mse = MLmetrics::MSE(y_true = high, high.Point.Forecast), 
          high.rmse = MLmetrics::RMSE(y_true = high, y_pred = high.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

low.accr <- ftl2[, {
  low = low
  low.Point.Forecast = low.Point.Forecast
  .SD[, .(.N, 
          low.mae = MAE(low, low.Point.Forecast), 
          low.mape = MLmetrics::MAPE(y_true = low, low.Point.Forecast), 
          low.smape = Metrics::smape(actual = low, predicted = low.Point.Forecast), 
          low.mse = MLmetrics::MSE(y_true = low, low.Point.Forecast), 
          low.rmse = MLmetrics::RMSE(y_true = low, y_pred = low.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

close.accr <- ftl2[, {
  close = close
  close.Point.Forecast = close.Point.Forecast
  .SD[, .(.N, 
          close.mae = MAE(close, close.Point.Forecast), 
          close.mape = MLmetrics::MAPE(y_true = close, close.Point.Forecast), 
          close.smape = Metrics::smape(actual = close, predicted = close.Point.Forecast), 
          close.mse = MLmetrics::MSE(y_true = close, close.Point.Forecast), 
          close.rmse = MLmetrics::RMSE(y_true = close, y_pred = close.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

open.sm <- open.accr[, list(
  N = mean(N), 
  open.mae = mean(open.mae), 
  open.mape = mean(open.mape), 
  open.smape = mean(open.smape), 
  open.mse = mean(open.mse), 
  open.rmse = mean(open.rmse)), 
  by=.(Model, Period)]

high.sm <- high.accr[, list(
  N = mean(N), 
  high.mae = mean(high.mae), 
  high.mape = mean(high.mape), 
  high.smape = mean(high.smape), 
  high.mse = mean(high.mse), 
  high.rmse = mean(high.rmse)), 
  by=.(Model, Period)]

low.sm <- low.accr[, list(
  N = mean(N), 
  low.mae = mean(low.mae), 
  low.mape = mean(low.mape), 
  low.smape = mean(low.smape), 
  low.mse = mean(low.mse), 
  low.rmse = mean(low.rmse)), 
  by=.(Model, Period)]

close.sm <- close.accr[, list(
  N = mean(N), 
  close.mae = mean(close.mae), 
  close.mape = mean(close.mape), 
  close.smape = mean(close.smape), 
  close.mse = mean(close.mse), 
  close.rmse = mean(close.rmse)), 
  by=.(Model, Period)]

ftl_dat2b <- join_all(list(open.sm, high.sm, low.sm, close.sm)) %>% 
  as_tibble
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb19 <- ftl_dat2b %>% 
  dplyr::mutate(
    open.mae = ifelse(
      rank(open.mae) <= 3, 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mape = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.smape = ifelse(
      rank(open.smape) <= 3, 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mse = ifelse(
      rank(open.mse) <= 3, 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.rmse = ifelse(
      rank(open.rmse) <= 3, 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    high.mape = ifelse(
      rank(high.mape) <= 3, 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.smape = ifelse(
      rank(high.smape) <= 3, 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.mse = ifelse(
      rank(high.mse) <= 3, 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.rmse = ifelse(
      rank(high.rmse) <= 3, 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    low.mape = ifelse(
      rank(low.mape) <= 3, 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.smape = ifelse(
      rank(low.smape) <= 3, 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.mse = ifelse(
      rank(low.mse) <= 3, 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.rmse = ifelse(
      rank(low.rmse) <= 3, 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    close.mape = ifelse(
      rank(close.mape) <= 3, 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.smape = ifelse(
      rank(close.smape) <= 3, 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.mse = ifelse(
      rank(close.mse) <= 3, 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.rmse = ifelse(
      rank(close.rmse) <= 3, 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min summarised to 1 day per unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  #column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>%   
  column_spec(7, background = 'Gainsboro') %>% 
  column_spec(8, background = 'LightGray') %>% 
  column_spec(9, background = 'Gainsboro') %>% 
  column_spec(10, background = 'LightGray') %>%   
  column_spec(11, background = 'Gainsboro') %>% 
  column_spec(12, background = 'LightGray') %>% 
  column_spec(13, background = 'Gainsboro') %>% 
  column_spec(14, background = 'LightGray') %>%   
  column_spec(15, background = 'Gainsboro') %>% 
  column_spec(16, background = 'LightGray') %>% 
  column_spec(17, background = 'Gainsboro') %>% 
  column_spec(18, background = 'LightGray') %>%  
  column_spec(19, background = 'Gainsboro') %>% 
  column_spec(20, background = 'LightGray') %>%  
  column_spec(21, background = 'Gainsboro') %>% 
  column_spec(22, background = 'LightGray') %>% 
  column_spec(23, background = 'Gainsboro') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb19
```

```{r include = FALSE}
rm(tb19)
```

Above table summarized the daily `mape`, `smape`, `mse` and `rmse` values and then summarized again the models (which is nested summarize <span style='color:red'>due to daily settlement for P&L</span>).

### Filtered `7200` mins `unique(x, fromLast = TRUE)` Dataset

#### Overview

```{r, warning = FALSE, message = FALSE, results = 'asis'}
ftl3 <- unique(ftl1, fromLast = TRUE, by = c('index', 'Period'))#[Period == 'mo.7200']#[11440:12900]#[order(index)]
#setkey(ftl3)
setkeyv(ftl3, c('index', 'Model', 'Period'))

m.op <- ftl3[, {
    open = open
    open.Point.Forecast = open.Point.Forecast
    .SD[, .(.N, 
            open.mae = MAE(open, open.Point.Forecast), 
            open.mape = MLmetrics::MAPE(y_true = open, open.Point.Forecast), 
            open.smape = Metrics::smape(actual = open, predicted = open.Point.Forecast), 
            open.mse = MLmetrics::MSE(y_true = open, open.Point.Forecast), 
            open.rmse = MLmetrics::RMSE(y_true = open, y_pred = open.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

m.hi <- ftl3[, {
    high = high
    high.Point.Forecast = high.Point.Forecast
    .SD[, .(.N, 
            high.mae = MAE(high, high.Point.Forecast), 
            high.mape = MLmetrics::MAPE(y_true = high, high.Point.Forecast), 
            high.smape = Metrics::smape(actual = high, predicted = high.Point.Forecast), 
            high.mse = MLmetrics::MSE(y_true = high, high.Point.Forecast), 
            high.rmse = MLmetrics::RMSE(y_true = high, y_pred = high.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

m.lo <- ftl3[, {
    low = low
    low.Point.Forecast = low.Point.Forecast
    .SD[, .(.N, 
            low.mae = MAE(low, low.Point.Forecast), 
            low.mape = MLmetrics::MAPE(y_true = low, low.Point.Forecast), 
            low.smape = Metrics::smape(actual = low, predicted = low.Point.Forecast), 
            low.mse = MLmetrics::MSE(y_true = low, low.Point.Forecast), 
            low.rmse = MLmetrics::RMSE(y_true = low, y_pred = low.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

m.cl <- ftl3[, {
    close = close
    close.Point.Forecast = close.Point.Forecast
    .SD[, .(.N, 
            close.mae = MAE(close, close.Point.Forecast), 
            close.mape = MLmetrics::MAPE(y_true = close, close.Point.Forecast), 
            close.smape = Metrics::smape(actual = close, predicted = close.Point.Forecast), 
            close.mse = MLmetrics::MSE(y_true = close, close.Point.Forecast), 
            close.rmse = MLmetrics::RMSE(y_true = close, y_pred = close.Point.Forecast)), 
        by=.(Model, Period)]}][order(Model, Period), ]

ftl_dat3a <- join_all(list(m.op, m.hi, m.lo, m.cl)) %>% 
  as_tibble
```

The models `r paste(unique(ftl2$Period)[str_detect(unique(ftl2$Period), '7200')], collapse = ', ')` predict `7200` mins data in advanced per day. But models `r paste(unique(ftl2$Period)[str_detect(unique(ftl2$Period), '1440')], collapse = ', ')` only predict `1440` mins data in advanced per day. Therefore there will be different data size and **duplicate forecasted price**.

Here I filtered to be unique forecasted price but `7200` mins in advanced per week. That means when I forecast data on `2015-01-17` for `2015-01-20` to `2015-01-25` which is the last `1440` mins among `7200` mins in advanced. (All dataset will be forecast `7200` in advanced since I only filter and take **last row of every single min**)

#### Overall Dataset

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb20 <- ftl_dat3a %>% 
  dplyr::mutate(
    open.mae = ifelse(
      rank(open.mae) <= 3, 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mape = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.smape = ifelse(
      rank(open.smape) <= 3, 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mse = ifelse(
      rank(open.mse) <= 3, 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.rmse = ifelse(
      rank(open.rmse) <= 3, 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    high.mape = ifelse(
      rank(high.mape) <= 3, 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.smape = ifelse(
      rank(high.smape) <= 3, 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.mse = ifelse(
      rank(high.mse) <= 3, 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.rmse = ifelse(
      rank(high.rmse) <= 3, 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    low.mape = ifelse(
      rank(low.mape) <= 3, 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.smape = ifelse(
      rank(low.smape) <= 3, 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.mse = ifelse(
      rank(low.mse) <= 3, 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.rmse = ifelse(
      rank(low.rmse) <= 3, 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    close.mape = ifelse(
      rank(close.mape) <= 3, 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.smape = ifelse(
      rank(close.smape) <= 3, 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.mse = ifelse(
      rank(close.mse) <= 3, 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.rmse = ifelse(
      rank(close.rmse) <= 3, 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min summarised to 1 day per unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>%   
  column_spec(7, background = 'Gainsboro') %>% 
  column_spec(8, background = 'LightGray') %>% 
  column_spec(9, background = 'Gainsboro') %>% 
  column_spec(10, background = 'LightGray') %>%   
  column_spec(11, background = 'Gainsboro') %>% 
  column_spec(12, background = 'LightGray') %>% 
  column_spec(13, background = 'Gainsboro') %>% 
  column_spec(14, background = 'LightGray') %>%   
  column_spec(15, background = 'Gainsboro') %>% 
  column_spec(16, background = 'LightGray') %>% 
  column_spec(17, background = 'Gainsboro') %>% 
  column_spec(18, background = 'LightGray') %>% 
  column_spec(19, background = 'Gainsboro') %>% 
  column_spec(20, background = 'LightGray') %>%  
  column_spec(21, background = 'Gainsboro') %>% 
  column_spec(22, background = 'LightGray') %>% 
  column_spec(23, background = 'Gainsboro') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb20
```

```{r include = FALSE}
rm(tb20)
```

Above table summarized the total observations with `mape`, `smape`, `mse` and `rmse` values (which is not nested summarize <span style='color:red'>not daily settlement for P&L</span>).

#### Daily Dataset

```{r, warning = FALSE, message = FALSE, results = 'asis'}
open.accr <- ftl3[, {
  open = open
  open.Point.Forecast = open.Point.Forecast
  .SD[, .(.N, 
          open.mae = MAE(open, open.Point.Forecast), 
          open.mape = MLmetrics::MAPE(y_true = open, open.Point.Forecast), 
          open.smape = Metrics::smape(actual = open, predicted = open.Point.Forecast), 
          open.mse = MLmetrics::MSE(y_true = open, open.Point.Forecast), 
          open.rmse = MLmetrics::RMSE(y_true = open, y_pred = open.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

high.accr <- ftl3[, {
  high = high
  high.Point.Forecast = high.Point.Forecast
  .SD[, .(.N, 
          high.mae = MAE(high, high.Point.Forecast), 
          high.mape = MLmetrics::MAPE(y_true = high, high.Point.Forecast), 
          high.smape = Metrics::smape(high, high.Point.Forecast), 
          high.mse = MLmetrics::MSE(y_true = high, high.Point.Forecast), 
          high.rmse = MLmetrics::RMSE(y_true = high, y_pred = high.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

low.accr <- ftl3[, {
  low = low
  low.Point.Forecast = low.Point.Forecast
  .SD[, .(.N, 
          low.mae = MAE(low, low.Point.Forecast), 
          low.mape = MLmetrics::MAPE(y_true = low, low.Point.Forecast), 
          low.smape = Metrics::smape(actual = low, predicted = low.Point.Forecast), 
          low.mse = MLmetrics::MSE(y_true = low, low.Point.Forecast), 
          low.rmse = MLmetrics::RMSE(y_true = low, y_pred = low.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

close.accr <- ftl3[, {
  close = close
  close.Point.Forecast = close.Point.Forecast
  .SD[, .(.N, 
          close.mae = MAE(close, close.Point.Forecast), 
          close.mape = MLmetrics::MAPE(y_true = close, close.Point.Forecast), 
          close.smape = Metrics::smape(actual = close, predicted = close.Point.Forecast), 
          close.mse = MLmetrics::MSE(y_true = close, close.Point.Forecast), 
          close.rmse = MLmetrics::RMSE(y_true = close, y_pred = close.Point.Forecast)), 
      by={index=as_date(index)}]}, 
  by=.(Model, Period)]

open.sm <- open.accr[, list(
  N = mean(N), 
  open.mae = mean(open.mae), 
  open.mape = mean(open.mape), 
  open.smape = mean(open.smape), 
  open.mse = mean(open.mse), 
  open.rmse = mean(open.rmse)), 
  by=.(Model, Period)]

high.sm <- high.accr[, list(
  N = mean(N), 
  high.mae = mean(high.mae), 
  high.mape = mean(high.mape), 
  high.smape = mean(high.smape), 
  high.mse = mean(high.mse), 
  high.rmse = mean(high.rmse)), 
  by=.(Model, Period)]

low.sm <- low.accr[, list(
  N = mean(N), 
  low.mae = mean(low.mae), 
  low.mape = mean(low.mape), 
  low.smape = mean(low.smape), 
  low.mse = mean(low.mse), 
  low.rmse = mean(low.rmse)), 
  by=.(Model, Period)]

close.sm <- close.accr[, list(
  N = mean(N), 
  close.mae = mean(close.mae), 
  close.mape = mean(close.mape), 
  close.smape = mean(close.smape), 
  close.mse = mean(close.mse), 
  close.rmse = mean(close.rmse)), 
  by=.(Model, Period)]

ftl_dat3b <- join_all(list(open.sm, high.sm, low.sm, close.sm)) %>% 
  as_tibble
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb21 <- ftl_dat3b %>% 
  dplyr::mutate(
    open.mae = ifelse(
      rank(open.mae) <= 3, 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mape = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.smape = ifelse(
      rank(open.smape) <= 3, 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mse = ifelse(
      rank(open.mse) <= 3, 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.rmse = ifelse(
      rank(open.rmse) <= 3, 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    high.mape = ifelse(
      rank(high.mape) <= 3, 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.smape = ifelse(
      rank(high.smape) <= 3, 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.mse = ifelse(
      rank(high.mse) <= 3, 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.rmse = ifelse(
      rank(high.rmse) <= 3, 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    low.mape = ifelse(
      rank(low.mape) <= 3, 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.smape = ifelse(
      rank(low.smape) <= 3, 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.mse = ifelse(
      rank(low.mse) <= 3, 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.rmse = ifelse(
      rank(low.rmse) <= 3, 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    close.mape = ifelse(
      rank(close.mape) <= 3, 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.smape = ifelse(
      rank(close.smape) <= 3, 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.mse = ifelse(
      rank(close.mse) <= 3, 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.rmse = ifelse(
      rank(close.rmse) <= 3, 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min summarised to 1 day per unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  #column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(4, background = 'LightGray') %>% 
  column_spec(5, background = 'Gainsboro') %>% 
  column_spec(6, background = 'LightGray') %>%   
  column_spec(7, background = 'Gainsboro') %>% 
  column_spec(8, background = 'LightGray') %>% 
  column_spec(9, background = 'Gainsboro') %>% 
  column_spec(10, background = 'LightGray') %>%   
  column_spec(11, background = 'Gainsboro') %>% 
  column_spec(12, background = 'LightGray') %>% 
  column_spec(13, background = 'Gainsboro') %>% 
  column_spec(14, background = 'LightGray') %>%   
  column_spec(15, background = 'Gainsboro') %>% 
  column_spec(16, background = 'LightGray') %>% 
  column_spec(17, background = 'Gainsboro') %>% 
  column_spec(18, background = 'LightGray') %>% 
  column_spec(19, background = 'Gainsboro') %>% 
  column_spec(20, background = 'LightGray') %>%  
  column_spec(21, background = 'Gainsboro') %>% 
  column_spec(22, background = 'LightGray') %>% 
  column_spec(23, background = 'Gainsboro') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE)#, height = '400px')

tb21
```

```{r include = FALSE}
rm(tb21)
```

Above table summarized the daily `mape`, `smape`, `mse` and `rmse` values and then summarized again the models (which is nested summarize <span style='color:red'>due to daily settlement for P&L</span>).

### Comparison All Filtered Data Models

```{r, warning = FALSE, message = FALSE, results = 'asis'}
compf <- list(
  'Unfilter Overall' = ftl_dat1a, 
  'Unfilter Daily' = ftl_dat1b, 
  'from First Overall' = ftl_dat2a, 
  'from First Daily' = ftl_dat2b, 
  'from Last Overvall' = ftl_dat3a, 
  'from Last Daily' = ftl_dat3b) %>% 
    ldply %>% 
    as_tibble %>% 
    dplyr::mutate(.id = factor(.id))

compf2 <- list(
  'from First Overall' = ftl_dat2a, 
  'from First Daily' = ftl_dat2b, 
  'from Last Overvall' = ftl_dat3a, 
  'from Last Daily' = ftl_dat3b) %>% 
    ldply %>% 
    as_tibble %>% 
    dplyr::mutate(.id = factor(.id))

rm(ftl_dat1a, ftl_dat1b, ftl_dat2a, ftl_dat3a, ftl_dat3b)
gc()
```

```{r, warning = FALSE, message = FALSE, results = 'asis'}
tb22 <- compf %>% 
  dplyr::mutate(
    open.mae = ifelse(
      rank(open.mae) <= 3, 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mape = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.smape = ifelse(
      rank(open.smape) <= 3, 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mse = ifelse(
      rank(open.mse) <= 3, 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.rmse = ifelse(
      rank(open.rmse) <= 3, 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    high.mape = ifelse(
      rank(high.mape) <= 3, 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.smape = ifelse(
      rank(high.smape) <= 3, 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.mse = ifelse(
      rank(high.mse) <= 3, 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.rmse = ifelse(
      rank(high.rmse) <= 3, 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    low.mape = ifelse(
      rank(low.mape) <= 3, 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.smape = ifelse(
      rank(low.smape) <= 3, 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.mse = ifelse(
      rank(low.mse) <= 3, 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.rmse = ifelse(
      rank(low.rmse) <= 3, 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    close.mape = ifelse(
      rank(close.mape) <= 3, 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.smape = ifelse(
      rank(close.smape) <= 3, 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.mse = ifelse(
      rank(close.mse) <= 3, 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.rmse = ifelse(
      rank(close.rmse) <= 3, 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min per unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = '#4E79A7') %>% 
  column_spec(2, background = 'CornflowerBlue') %>% 
  column_spec(3, background = 'CornflowerBlue') %>% 
  column_spec(4, background = '#5b65a7') %>% 
  #column_spec(5, background = '#A0CBE8') %>% 
  column_spec(5, background = 'LightGray') %>% 
  column_spec(6, background = 'Gainsboro') %>% 
  column_spec(7, background = 'LightGray') %>% 
  column_spec(8, background = 'Gainsboro') %>% 
  column_spec(9, background = 'LightGray') %>%   
  column_spec(10, background = 'Gainsboro') %>% 
  column_spec(11, background = 'LightGray') %>% 
  column_spec(12, background = 'Gainsboro') %>% 
  column_spec(13, background = 'LightGray') %>%   
  column_spec(14, background = 'Gainsboro') %>% 
  column_spec(15, background = 'LightGray') %>% 
  column_spec(16, background = 'Gainsboro') %>% 
  column_spec(17, background = 'LightGray') %>%   
  column_spec(18, background = 'Gainsboro') %>% 
  column_spec(19, background = 'LightGray') %>% 
  column_spec(20, background = 'Gainsboro') %>% 
  column_spec(21, background = 'LightGray') %>%  
  column_spec(22, background = 'Gainsboro') %>% 
  column_spec(23, background = 'LightGray') %>% 
  column_spec(24, background = 'Gainsboro') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE, height = '400px')

tb22
```

```{r include = FALSE}
rm(tb22)
```

### Comparison All Filtered Data Best Models

```{r, warning = FALSE, message = FALSE, results = 'asis'}
## https://stackoverflow.com/questions/2453326/fastest-way-to-find-second-third-highest-lowest-value-in-vector-or-column
b.op.mae <- compf2[order(compf2$open.mae), ] %>% head(3)
b.op.mape <- compf2[order(compf2$open.mape), ] %>% head(3)
b.op.smape <- compf2[order(compf2$open.smape), ] %>% head(3)
b.op.mse <- compf2[order(compf2$open.mse), ] %>% head(3)
b.op.rmse <- compf2[order(compf2$open.rmse), ] %>% head(3)
b.op <- bind_rows(list(b.op.mae, b.op.mape, b.op.smape, b.op.mse, b.op.rmse)) %>% 
  as_tibble %>% unique
b.op %<>% dplyr::select(c(.id, Model, Period, N, contains('open')))
rm(b.op.mae, b.op.mape, b.op.smape, b.op.mse, b.op.rmse)

b.hi.mae <- compf2[order(compf2$high.mae), ] %>% head(3)
b.hi.mape <- compf2[order(compf2$high.mape), ] %>% head(3)
b.hi.smape <- compf2[order(compf2$high.smape), ] %>% head(3)
b.hi.mse <- compf2[order(compf2$high.mse), ] %>% head(3)
b.hi.rmse <- compf2[order(compf2$high.rmse), ] %>% head(3)
b.hi <- bind_rows(list(b.hi.mae, b.hi.mape, b.hi.smape, b.hi.mse, b.hi.rmse)) %>% 
  as_tibble %>% unique
b.hi %<>% dplyr::select(c(.id, Model, Period, N, contains('high')))
rm(b.hi.mae, b.hi.mape, b.hi.smape, b.hi.mse, b.hi.rmse)

b.lo.mae <- compf2[order(compf2$low.mae), ] %>% head(3)
b.lo.mape <- compf2[order(compf2$low.mape), ] %>% head(3)
b.lo.smape <- compf2[order(compf2$low.smape), ] %>% head(3)
b.lo.mse <- compf2[order(compf2$low.mse), ] %>% head(3)
b.lo.rmse <- compf2[order(compf2$low.rmse), ] %>% head(3)
b.lo <- bind_rows(list(b.lo.mae, b.lo.mape, b.lo.smape, b.lo.mse, b.lo.rmse)) %>% 
  as_tibble %>% unique
b.lo %<>% dplyr::select(c(.id, Model, Period, N, contains('low')))
rm(b.lo.mae, b.lo.mape, b.lo.smape, b.lo.mse, b.lo.rmse)

b.cl.mae <- compf2[order(compf2$close.mae), ] %>% head(3)
b.cl.mape <- compf2[order(compf2$close.mape), ] %>% head(3)
b.cl.smape <- compf2[order(compf2$close.smape), ] %>% head(3)
b.cl.mse <- compf2[order(compf2$close.mse), ] %>% head(3)
b.cl.rmse <- compf2[order(compf2$close.rmse), ] %>% head(3)
b.cl <- bind_rows(list(b.cl.mae, b.cl.mape, b.cl.smape, b.cl.mse, b.cl.rmse)) %>% 
  as_tibble %>% unique
b.cl %<>% dplyr::select(c(.id, Model, Period, N, contains('close')))
rm(b.cl.mae, b.cl.mape, b.cl.smape, b.cl.mse, b.cl.rmse)
```

#### Open Price

```{r, warning = FALSE, message = FALSE, results = 'asis'}
b.op %>% 
    dplyr::mutate(
        open.mae = ifelse(
            rank(open.mae) <= 3, 
            cell_spec(
                paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        open.mape = ifelse(
            rank(open.mape) <= 3, 
            cell_spec(
                paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        open.smape = ifelse(
            rank(open.smape) <= 3, 
            cell_spec(
                paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        open.mse = ifelse(
            rank(open.mse) <= 3, 
            cell_spec(
                paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        open.rmse = ifelse(
            rank(open.rmse) <= 3, 
            cell_spec(
                paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
                'html', color = 'grey', italic = TRUE))) %>% 
    kbl('html', caption = 'Comparison of Models (Open Price 1 min per unit)', escape = FALSE) %>% 
    row_spec(0, background = 'DimGrey') %>% 
    column_spec(1, background = '#4E79A7') %>% 
    column_spec(2, background = 'CornflowerBlue') %>% 
    column_spec(3, background = 'CornflowerBlue') %>% 
    column_spec(4, background = '#5b65a7') %>% 
    
    kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
    kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
    scroll_box(width = '100%', fixed_thead = TRUE, height = '400px')
```

#### High Price

```{r, warning = FALSE, message = FALSE, results = 'asis'}
b.hi %>% 
    dplyr::mutate(
        high.mae = ifelse(
            rank(high.mae) <= 3, 
            cell_spec(
                paste0(round(high.mae, 7), ' (rank: ', sprintf('%1.f', rank(high.mae)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(high.mae, 7), ' (rank: ', sprintf('%1.f', rank(high.mae)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        high.mape = ifelse(
            rank(high.mape) <= 3, 
            cell_spec(
                paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        high.smape = ifelse(
            rank(high.smape) <= 3, 
            cell_spec(
                paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        high.mse = ifelse(
            rank(high.mse) <= 3, 
            cell_spec(
                paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        high.rmse = ifelse(
            rank(high.rmse) <= 3, 
            cell_spec(
                paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
                'html', color = 'grey', italic = TRUE))) %>% 
    kbl('html', caption = 'Comparison of Models (High Price 1 min per unit)', escape = FALSE) %>% 
    row_spec(0, background = 'DimGrey') %>% 
    column_spec(1, background = '#4E79A7') %>% 
    column_spec(2, background = 'CornflowerBlue') %>% 
    column_spec(3, background = 'CornflowerBlue') %>% 
    column_spec(4, background = '#5b65a7') %>% 
    
    kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
    kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
    scroll_box(width = '100%', fixed_thead = TRUE, height = '400px')
```

#### Low Price

```{r, warning = FALSE, message = FALSE, results = 'asis'}
b.lo %>% 
    dplyr::mutate(
        low.mae = ifelse(
            rank(low.mae) <= 3, 
            cell_spec(
                paste0(round(low.mae, 7), ' (rank: ', sprintf('%1.f', rank(low.mae)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(low.mae, 7), ' (rank: ', sprintf('%1.f', rank(low.mae)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        low.mape = ifelse(
            rank(low.mape) <= 3, 
            cell_spec(
                paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        low.smape = ifelse(
            rank(low.smape) <= 3, 
            cell_spec(
                paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        low.mse = ifelse(
            rank(low.mse) <= 3, 
            cell_spec(
                paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        low.rmse = ifelse(
            rank(low.rmse) <= 3, 
            cell_spec(
                paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
                'html', color = 'grey', italic = TRUE))) %>% 
    kbl('html', caption = 'Comparison of Models (Low Price 1 min per unit)', escape = FALSE) %>% 
    row_spec(0, background = 'DimGrey') %>% 
    column_spec(1, background = '#4E79A7') %>% 
    column_spec(2, background = 'CornflowerBlue') %>% 
    column_spec(3, background = 'CornflowerBlue') %>% 
    column_spec(4, background = '#5b65a7') %>% 
    
    kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
    kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
    scroll_box(width = '100%', fixed_thead = TRUE, height = '400px')
```

#### Close Price

```{r, warning = FALSE, message = FALSE, results = 'asis'}
b.cl %>% 
    dplyr::mutate(
        close.mae = ifelse(
            rank(close.mae) <= 3, 
            cell_spec(
                paste0(round(close.mae, 7), ' (rank: ', sprintf('%1.f', rank(close.mae)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(close.mae, 7), ' (rank: ', sprintf('%1.f', rank(close.mae)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        close.mape = ifelse(
            rank(close.mape) <= 3, 
            cell_spec(
                paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        close.smape = ifelse(
            rank(close.smape) <= 3, 
            cell_spec(
                paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        close.mse = ifelse(
            rank(close.mse) <= 3, 
            cell_spec(
                paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
                'html', color = 'grey', italic = TRUE)), 
        close.rmse = ifelse(
            rank(close.rmse) <= 3, 
            cell_spec(
                paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
                'html', color = 'darkgoldenrod', bold = TRUE), 
            cell_spec(
                paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
                'html', color = 'grey', italic = TRUE))) %>% 
    kbl('html', caption = 'Comparison of Models (Low Price 1 min per unit)', escape = FALSE) %>% 
    row_spec(0, background = 'DimGrey') %>% 
    column_spec(1, background = '#4E79A7') %>% 
    column_spec(2, background = 'CornflowerBlue') %>% 
    column_spec(3, background = 'CornflowerBlue') %>% 
    column_spec(4, background = '#5b65a7') %>% 
    
    kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
    kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
    scroll_box(width = '100%', fixed_thead = TRUE, height = '400px')
```



```{r}
tb23 <- compf2 %>% 
  dplyr::mutate(
    open.mae = ifelse(
      rank(open.mae) <= 3, 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mae, 7), ' (rank: ', sprintf('%1.f', rank(open.mae)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mape = ifelse(
      rank(open.mape) <= 3, 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mape, 7), ' (rank: ', sprintf('%1.f', rank(open.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.smape = ifelse(
      rank(open.smape) <= 3, 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.smape, 7), ' (rank: ', sprintf('%1.f', rank(open.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.mse = ifelse(
      rank(open.mse) <= 3, 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.mse, 7), ' (rank: ', sprintf('%1.f', rank(open.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    open.rmse = ifelse(
      rank(open.rmse) <= 3, 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(open.rmse, 7), ' (rank: ', sprintf('%1.f', rank(open.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    high.mape = ifelse(
      rank(high.mape) <= 3, 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mape, 7), ' (rank: ', sprintf('%1.f', rank(high.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.smape = ifelse(
      rank(high.smape) <= 3, 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.smape, 7), ' (rank: ', sprintf('%1.f', rank(high.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.mse = ifelse(
      rank(high.mse) <= 3, 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.mse, 7), ' (rank: ', sprintf('%1.f', rank(high.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    high.rmse = ifelse(
      rank(high.rmse) <= 3, 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(high.rmse, 7), ' (rank: ', sprintf('%1.f', rank(high.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    low.mape = ifelse(
      rank(low.mape) <= 3, 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mape, 7), ' (rank: ', sprintf('%1.f', rank(low.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.smape = ifelse(
      rank(low.smape) <= 3, 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.smape, 7), ' (rank: ', sprintf('%1.f', rank(low.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.mse = ifelse(
      rank(low.mse) <= 3, 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.mse, 7), ' (rank: ', sprintf('%1.f', rank(low.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    low.rmse = ifelse(
      rank(low.rmse) <= 3, 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(low.rmse, 7), ' (rank: ', sprintf('%1.f', rank(low.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    
    close.mape = ifelse(
      rank(close.mape) <= 3, 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mape, 7), ' (rank: ', sprintf('%1.f', rank(close.mape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.smape = ifelse(
      rank(close.smape) <= 3, 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.smape, 7), ' (rank: ', sprintf('%1.f', rank(close.smape)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.mse = ifelse(
      rank(close.mse) <= 3, 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.mse, 7), ' (rank: ', sprintf('%1.f', rank(close.mse)), ')'), 
        'html', color = 'grey', italic = TRUE)), 
    close.rmse = ifelse(
      rank(close.rmse) <= 3, 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'darkgoldenrod', bold = TRUE), 
      cell_spec(
        paste0(round(close.rmse, 7), ' (rank: ', sprintf('%1.f', rank(close.rmse)), ')'), 
        'html', color = 'grey', italic = TRUE))) %>% 
  kbl('html', caption = 'Comparison of Models (1 min per unit)', escape = FALSE) %>% 
  ## https://www.w3schools.com/cssref/css_colors.asp
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = '#4E79A7') %>% 
  column_spec(2, background = 'CornflowerBlue') %>% 
  column_spec(3, background = 'CornflowerBlue') %>% 
  column_spec(4, background = '#5b65a7') %>% 
  #column_spec(5, background = '#A0CBE8') %>% 
  column_spec(5, background = 'LightGray') %>% 
  column_spec(6, background = 'Gainsboro') %>% 
  column_spec(7, background = 'LightGray') %>% 
  column_spec(8, background = 'Gainsboro') %>% 
  column_spec(9, background = 'LightGray') %>%   
  column_spec(10, background = 'Gainsboro') %>% 
  column_spec(11, background = 'LightGray') %>% 
  column_spec(12, background = 'Gainsboro') %>% 
  column_spec(13, background = 'LightGray') %>%   
  column_spec(14, background = 'Gainsboro') %>% 
  column_spec(15, background = 'LightGray') %>% 
  column_spec(16, background = 'Gainsboro') %>% 
  column_spec(17, background = 'LightGray') %>%   
  column_spec(18, background = 'Gainsboro') %>% 
  column_spec(19, background = 'LightGray') %>% 
  column_spec(20, background = 'Gainsboro') %>% 
  column_spec(21, background = 'LightGray') %>%  
  column_spec(22, background = 'Gainsboro') %>% 
  column_spec(23, background = 'LightGray') %>% 
  column_spec(24, background = 'Gainsboro') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  kable_material(full_width = FALSE) %>% ##`full_width = FALSE` will auto adjust every single columns width to fit the table full width.
  scroll_box(width = '100%', fixed_thead = TRUE, height = '400px')

tb23
```

```{r include = FALSE}
rm(tb23)
```

# Conclusion

## Summary


```{r, option, echo = FALSE}
## Set options back to original options
options(warn = 0)
```

# Appendix

## Blooper

## Documenting File Creation 

It's useful to record some information about how your file was created.

- File creation date: 2021-01-31
- File latest updated date: `r today('Asia/Tokyo')`
- `r R.version.string`
- R version (short form): `r getRversion()`
- [**rmarkdown** package](https://github.com/rstudio/rmarkdown) version: `r packageVersion('rmarkdown')`
- File version: 1.0.1
- Author Profile: [®γσ, Eng Lian Hu](https://github.com/scibrokes/owner)
- GitHub: [Source Code](https://github.com/englianhu/binary.com-interview-question)
- Additional session information:

```{r, warning = FALSE, results = 'asis'}
suppressMessages(require('dplyr', quietly = TRUE))
suppressMessages(require('magrittr', quietly = TRUE))
suppressMessages(require('formattable', quietly = TRUE))
suppressMessages(require('knitr', quietly = TRUE))
suppressMessages(require('kableExtra', quietly = TRUE))

sys1 <- devtools::session_info()$platform %>% 
  unlist %>% data.frame(Category = names(.), session_info = .)
rownames(sys1) <- NULL

sys2 <- data.frame(Sys.info()) %>% 
  dplyr::mutate(Category = rownames(.)) %>% .[2:1]
names(sys2)[2] <- c('Sys.info')
rownames(sys2) <- NULL

if (nrow(sys1) == 9 & nrow(sys2) == 8) {
  sys2 %<>% rbind(., data.frame(
  Category = 'Current time', 
  Sys.info = paste(as.character(lubridate::now('Asia/Tokyo')), 'JST🗾')))
} else {
  sys1 %<>% rbind(., data.frame(
  Category = 'Current time', 
  session_info = paste(as.character(lubridate::now('Asia/Tokyo')), 'JST🗾')))
}

sys <- cbind(sys1, sys2) %>% 
  kbl(caption = 'Additional session information:') %>% 
  kable_styling(bootstrap_options = c('striped', 'hover', 'condensed', 'responsive')) %>% 
  row_spec(0, background = 'DimGrey') %>% 
  column_spec(1, background = 'CornflowerBlue') %>% 
  column_spec(2, background = 'DarkGrey') %>% 
  #column_spec(3, background = 'LightSlateGrey') %>% 
  column_spec(3, background = 'CornflowerBlue') %>% 
  column_spec(4, background = 'DarkGrey') %>% 
  row_spec(9, bold = T, color = 'white', background = '#D7261E')

rm(sys1, sys2)
sys
```

## Reference

01. [Deriv.com - Interday High Frequency Trading Models Comparison <span style='color:red'>(Blooper)</span>](https://rpubs.com/englianhu/binary-Q1Inter-HFT)
02. [Forecasting: Principles and Practice](https://otexts.com/fpp3)

---

<span style='color:RoyalBlue'>**Powered by - Copyright® Intellectual Property Rights of <img src='www/scb-logo3rs.jpg' width='24'> [Sςιβrοκεrs Trαdιηg®️](http://www.scibrokes.com)経営企業**</span>
